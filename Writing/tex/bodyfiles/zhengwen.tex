\chapter{绪论}

在本章中，首先介绍重症监护室中肾功能衰竭患者生存分析研究的背景与意义，
然后就目前重症肾功能衰竭生存分析领域的研究现状进行介绍，最后介绍本文的主要工作和组织架构。

%---------------------------------------
\section{研究背景与问题的提出}
%---------------------------------------
慢性肾病(Chronic Kidney Disease, CKD)是一种典型的肝肾疾病，2002年美国肾脏基金会指出，其是由不同因素所引起肾功能损伤的病变总称，
包括肾衰竭、肾病综合征、肾功能异常、肾结石等\cite{DOQI02,CDC07}。其中肾功能衰竭(Renel Failure, RF)是指由各种慢性肾功能
疾病进展至后期所导致的肾功能部分或全面损害的疾病状况，又称慢性肾功能衰竭\cite{CHben92,CHhuang20}。

肾衰竭是复杂相互作用的结果，影响其加重和加速肾脏损害的进展因素主要为持续性蛋白尿、SAH、DM2、抽烟、血脂异常、贫血、相关血管疾病
和肥胖。按照肾功能衰竭发作的缓急程度分为急性肾功能衰竭和慢性肾功能衰竭两种。一般来说,慢性肾衰竭发生的大部分因素是由于存在长
期的肾功能疾病，而伴随疾病的发展，肾的功能渐渐减退,导致慢性肾功能衰竭的发生\cite{CHzhao17}。多种渐进性损伤会导致肾间质纤维化的
发生，最终导致终末期肾衰竭\cite{Zhang08,Herzlinger02}。随着人类生活条件的提高、人们生活习惯的改变以及在社会人口构成中人口
老龄化的加剧，慢性肾病已演变成为威胁全球生命卫生健康的主要疾病之一。
但急性肾衰竭的发病发展迅速，往往由于肾部供血不足或肾部由于某些原因阻塞引起功能性破坏而导致急性肾衰竭的形成\cite{CHzhong09}。

从全球角度来看，全世界至少有8.5亿人患有各类肾病，约占世界总人口的11\%\cite{CHsong19,CHli18}，据以往研究报告，我国的慢性
肾病患者约占总人口的10.8\%，这个发病率已经与成人糖尿病患病率几乎相当。但慢性肾病的知晓率仅12.5\%，与糖尿病的知晓率36.5\%相
差甚远\cite{CHcheng18,CHwang18,CHjie15}。在中国肾脏疾病数据发布的2014年度报告中称，在所有住院人数中，慢性肾病患者占比
4.5\%，而糖尿病患者占比为8\%。但慢性肾病患者的死亡率为1.8\%远高于糖尿病患者的1.0\%。其中肾衰竭也是一种非常常见的非传染性
疾病，每年的发病增长率约为8\%\cite{CHsong19}。而肾功能衰竭作为一种不可逆转的临床症状，患者只能通过长期药物和持续的透析
或移植来控制病情的发展进而延长预期寿命。但目前中国的透析疗法等新技术的透析效率与同时期部分国家比较仍有不足，而且鉴于中国慢性
肾病在一般人群中的发生率较高、社会知晓度低、发病过程不可逆、院内死亡率较高、医疗费用昂贵等特征，慢性肾病逐渐引起社会和各个
卫生组织的重视，并开始致力于研究延缓慢性肾病进展的各种方法。

重症监护病房(Intensive Care Unit, ICU)作为重症患者最佳治疗方案在危重症疾病的治疗过程中充当着及其重要的角色。ICU是指通过将
危重患者集中起来，并在各个医疗救治方面为这类病人提供最全面的治疗和保障，使得重症患者能够得到及时且有效的治疗，从而降低患者的死亡
风险\cite{Groeger93}。但是如果患者的生命健康长期处于高风险的情况下，需要持续依赖生命支持系统的监护，此类慢性危重症患者
(Chronically Critical Ill, CCI)会占用大量医疗和社会资源。在美国每年危重病人的护理费用已经接近占比国内生产总值的1\%左
右\cite{Halpern10}。同时，对病人及其家属来说，ICU病房势必会产生巨大的医药花费，而对大多数一般家庭来说都会形成不小的社会经
济压力。除此之外，尽管ICU病房能够提供一个最佳的治疗保障水平，但其疾病的复发率和死亡率仍然远远高于普通病房。2009年至2012年期间，
美国所有ICU病房住院患者的平均医院死亡率约为11\%至12\%。由此可见，病人在ICU诊疗阶段的生存分析研究对制订医学诊疗政策以及
评价重症病情的严重程度都有着十分关键的影响与意义。


对于重症肾功能衰竭疾病的生存分析研究而言，主要包括两个目的。一方面是通过患者的生理指标、病理特征等来持续性的评估和监测其疾病
进程的严重程度和死亡风险发生的概率。另一方面是准确识别出有高死亡风险的患者，辅助医护救助人员对这类患者提供进一步的干预
和监测，从而防止此类患者病情的出现恶化与加重。且关于死亡风险的推断可以辅助医生判断患者接下来的治疗模式。因此，关于ICU病人
的生存分析研究对于降低患者的死亡风险、识别病情恶化的患者、医疗资源的合理分配都有着重要的作用。通过生存分析研究,为已进入
ICU病房的重症肾脏功能衰竭的病人延长其存活时间，提供了必要的临床依据。


%---------------------------------------
\section{国内外研究现状}
%---------------------------------------

重症监护室中肾功能衰竭患者死亡率的预测是一项非常有意义并且有挑战性的工作，
准确快速的识别出哪些患者处于高生存风险状态，需要采取急救措施并且给予这部分患者最好的医
护治疗，有助于增加危重患者的生存机率，减少死亡风险的发生。因此，越来
越多的科研人员致力于这方面的研究，并提出了许多肾功能衰竭与生存分析研究的相关研究方法。

%---------------------------------------
\subsection{肾衰竭的研究}
%---------------------------------------
\vspace{-0.5em}
一直以来，关于肝肾疾病的危险因素研究在生物医学领域都广泛受到了国内外众多研究者的关注。日本的Okinawa保健学会,经过连续十多年的筛查计划
确认了ESRD的主要风险因子,包括蛋白尿、血尿、低血压、中高龄和性别\cite{Melendez12}。
泰国的流行病学研究表明,收缩压超过159毫米汞柱、血尿酸值超过0.378mmoL/L、甘油三酯值超过或大于6.46mmoL/l,以及BMI指标超过24.9是肾脏功能衰
退的独立风险因子。北大医学部的研究表明,高尿酸血症、白蛋白尿、年纪增长10岁、性别、高胆固醇血症和肾功能下降独立相关\cite{Nakagawa06}。
张晓光等人使用Logistic回归法分析了CKD进展的风险原因,在研究结果中显示大量蛋白尿、高尿酸血症、心功能紊乱、高血糖、男性、老年、重度缺血、
低密度脂蛋白升高是CKD进展的危险因素\cite{CHzhang10}。根据以上国内外研究总结来看，对于CKD患者，危险因素
可总结分为长期危险因素和短期加重因素。长期危险因素包括患者特征、即发病未控制、内环境及代谢紊乱、不良生活习惯、营养不良等。
短期加载因素包括感染、水电解质紊乱、肾毒性药物、低血容量等。

除对于肾病的风险因素探讨之外，对于ICU的重症病人的死亡率估计一直也是一个十分有意义而且存在相当挑战性的任务，准确迅速的确定了
这些病人必须进行额外的干预措施，并且给予这部分患者最好的医护治疗，有助于增加重症患者的存活几率。而对于病人生存寿命研究的
方式最早主要采用生理表格进行评价\cite{Moreno83}，它引入了与患者寿命密切关联的指标进行了统计学分析，通过把患者当前的状态指标和生
理表格中的指标进行对比，由此来推断出病人的死亡率。不过这种方法容易受到样本数量限制以及人群间的差异性等问题的干扰，导致在
利用生理表格对患者进行死亡率预测时准确度很低。

为更全面的对病人在重症监护室中的死亡危险性做出评价,学者们给出了一些经典的评价方式，如急性生理与慢性健康评分(APACHE)\cite{Lee93}、序贯器官衰竭评
分(SOFA)\cite{Vincent96}和简化急性生理评分(SAPS)\cite{Le84}。这几种评分指标由医学领域专家选择的患者加权生理变量计算而得到的，用来评估重症监护室
中住院患者疾病的严重程度。这些评分方法在计算步骤中通过较为精心的设计，在开展患者死亡率预测的实证研究中时，相比较生命表格而言，它们大大提高了预测的准确度。

%---------------------------------------
\subsection{生存分析的研究}
%---------------------------------------
\vspace{-0.5em}
生存分析在经济、金融、工程、医学等许多邻域都是一项基础性分析方法，也被称为事件-时间分析。统计和生物医学领域中使用最广泛的
生存模型便是Kaplan-Meier估计(KM)\cite{Kaplan58}，它的优点是能够学习非常灵活的生存曲线，但其缺点是没有纳入患者
的协变量。因此，它在种群水平上有用，但在个体水平上用处不大。在1972年Cox提出了Cox比例风险模型(Cox
 Proportional Hazard, CPH)\cite{Cox72}。这是一种半参数模型，用于计算观察到的协变量对事件(例如死亡、疾病复发等)发生风险的影响。能够
 纳入患者的协变量，使得生存分析模型从种群水平拓展到个体水平上。但CPH模型有一个强假设条件是假设风险率是恒定的且风险
 率的对数是协变量的线性函数，这个假设条件也被称为线性比例风险条件。CPH模型目前依然是生存分析领域最经典的模型。

其他模型关于基本的随机过程和关于协变量和假设过程的参数之间的关系都做出了不同的假设：Longini等人在1989年假设了马尔可夫
链\cite{Longini89}。2006年Whitmore提出了另外一种生存分析模型，这个模型通过假设个体的风险函数为服从某个带参数的特定分
布的随机过程，以此来推断事件发生时间的概率密度，称为FHT首次命中事件模型(First Hitting Time Model, FHT)\cite{Lee10,Lee06}。

由于它们将生存分析表达为确定指定随机过程第一次到达边界时的分布问题，因此这些模型能够包含竞争风险。但是也有一个非常明显的缺
点，就是对潜在的随机过程以及该过程的协变量和参数之间的关系做出了许多强有力的假设。也就是说，除非我们以及了解了潜在的随机过
程，否则这些模型的用途非常有限。而在生物医学领域中，这意味着了解潜在的疾病过程似乎是一个比生存分析本身更加复杂的问题，尤其
是因为疾病或疾病的状态通常时不确定的(不能直接观测)。因此需要更加鲁棒的生存分析模型，以此来更好的拟合具有非线性对数风险性质的生存数据。

随着机器学习模型的兴起，生存分析问题最近十几年也在机器学习的研究中得到了大量的关注。在2008年Ishwaran等人在生存树的基础上，
结合随机森林思想，提出了随机生存森林(Random Survival Forests，RSF)。
随机生存的森林模型通过对数秩检验作为分析准则来估计随机森林,并通过计算树叶节点的累计风险并把它们平均化。随机生存森林所使用的是
一个非常灵活的连续时间方法，同时其不受比例假设的约束的特性导致其在实证研究中被广泛使用\cite{Ishwaran08}。2011年Yu提出了一
种依赖Logistic回归的局部回归方法，用于根据血液检测和
临床评估等患者属性学习患者特定的生存时间分布。并表明提出的方法在生存时间预测方面比流行的生存分布模型更加准确\cite{Yu11}。
Ranganath和Blei在2016年将一种带有深度指数家族的生存分析方法应用到电子健康记录数据中，并在结果中验证了这种深度生存分析的
有效性，结果表明深度生存分析在根据风险对患者进行分层方面具有优势\cite{Ranganath16}。同年Fernndez，Rivera和The提出了基于
高斯过程的半参数贝叶斯模型\cite{Fern16}。所有的这些方法都能够纳入患者的协变量，但是却都没有考虑到相互竞争风险的问题。虽然
这些模型可以通过修正单个事件和简化考虑其他事件以此来使模型适用于竞争风险问题，但如果竞争风险并不独立的话，明显这种
处理方法是不够的。

为了解决这些问题，国内外研究人员尝试将神经网络模型应用于生存问题中。一种是将其考虑为分类问题，例如1994年Liestol和Andersen在考
虑了前馈神经网络及其与生存数据回归模型的关系后，展示了如何使用反向传播算法在某些标准回归模型中获得最大似然估计\cite{Liestol94}。
第二种是对时间进行编码处理\cite{Biganzoli98,Jerez05}，第三种是预测风险函数的方法。1995年Faraggi和Simon首次研究了神经网络模
型在生存数据和生存分析研究中的应用，与传统的CPH模型相比，研究中使用了前馈神经网络来学习协变量和风险函数之间的关系。
以此来对CPH模型进行了非线性的扩展\cite{Faraggi95}。然后Xiang等人研究发现该模型在应用效果上往往表现差于传统的CPH模型，然这与
当时的计算机算力以及单隐层神经网络有一定限制\cite{Sargent01,Xiang00}。Zhu等人使用卷积式神经网络取代了以往的多层感知机,并提
出了两种基于CPH模型的图像数据处理的深入学习模式\cite{Zhu16}，并将这些方法应用于肺癌的病理图像和整个组织病理图像验证模型的训
练效果，直接利用图像来预测患者的预后情况。2017年Safoora Yousefi等人提出了SurvivalNet模型框架\cite{Yousefi17}，
这是一个将CPH模型与神经网络和贝叶斯参数优化进行了整合的深度学习框架，同时通过大量的基因数据验证了高纬度下的性能表现力。
2018年Katzman等人在最新的深度学习的框架内重新审视了已有的这些模型，提出了DeepSurv模型\cite{Katzman18}，
并在实验数据和真实数据中显示出新模型在C指数方面能够胜过Cox比例风险模型，但是模型仍然受到了比例风险假设的约束。DeepSurv采用了
相似的方法但是使用了更加复杂的网络架构和损失函数。这些工作改进了CPH模型，放松了标准CPH模型中协变量和危险函数之间的特点函数关系，
同时保持了另一个中心假设：危险率随事件保持不变。因此，这些工作并没有充分利用深度神经网络学习复杂风险表示的潜在能力，特别是捕捉
协变量对生存时间依耐性影响的能力。同年Lee等人提出了一种名为DeepHit的方法\cite{Lee18}，DeepHit直接学习生存时间和时间的联合分布，
避免了假设底层随机过程的特定形式或底层随机过程的协变量关系。该技术通过使用神经网络估算概率质量参数,并将对数似然值和排名损失结合,
来实现身生存预测。另外,该方法还具有适合于竞争风险的额外功能。在研究的实验中表明了DeepHit的性能在竞争风险设置上显著改善了之前模型
的性能。2019 年,Kvamme等人在先前研究成果的基础上,通过使用神经网络扩展CPH模型,给出了全新的事件时间估计模型
Cox-CC、Cox-Time\cite{Kvamme19}。其中Cox-CC是对CPH模型的非线形扩充,而Cox-Time则是对CPH模型的非线型非比例扩充。他们
根据嵌套案例控制研究的方法理念,提供了一种能够很好地缩放到大型数据的集中损失函数,以及同样又能够兼容性地拟合了比例和非比例
扩张的CPH模型。这两个方法在持续建模事件时间的同时,又具备了神经网络的灵活性,并且借助于模拟研究结果和对实际数据收集过程的验证,这
两个方法在生存分析中都具备了极高的竞争性。

%---------------------------------------
\section{研究内容与组织结构}
%---------------------------------------
本文研究主要是针对最新发布的MIMIC-IV v1.0公开数据库中，建立完整的重症监护室中肾功能衰竭患者临床资料的生存
分析研究方法，对数据进行提取和初步分析，并构建多种生存分析统计模型对院内死亡率进行预测，采用多维度的生存评
价指标度量对本文所采用的生存分析统计模型进行性能评价，判断重症监护室中肾功能衰竭患者院内死亡率预测的最佳模
型，在多维度下评价各个模型的优劣。具体是研究思路如下：

基于最新发布的MIMIC-IV大型公开数据库，提取了ICU中肾功能衰竭患者的临床资料。并对数据的格式和质量进行了
全方面的整理，然后通过对数据集划分子集为训练集、验证集、测试集进行模型拟合训练。

考虑了较为经典的带惩罚项的CPH模型、机器学习方法中采用了随机生成森林模型、深度学习方法中选择了最新提
出的4种生存模型：DeepSurv、Cox-CC、Cox-Time及LogisitcHazard模型，通过交叉验证和网格搜索优化深度生存
分析模型的参数，确定最优化参数组合进行训练。对带惩罚项的CPH模型通过筛选高重要性的变量纳入正式模型中
进行训练，对于随机生存森林模型采用默认的参数设置进行训练。

在模型训练完成之后，通过多维度视角对各模型进行了全面的评估和比较，其中包括C指数、$C^{td}$、BS、IBS
、ROC-Time，最后给出了重症肾功能衰竭患者生存时间的重要保护因素和危险因素。


本文关于ICU中肾脏功能衰竭病人的生存分析的研究共分为五个板块，具体组织框架如下：

第一章：首先对本研究的背景和意义进行了阐述，然后总结了国内外研究对于ICU肾功能衰竭的死亡率预测现状，以
及生存分析领域模型方法的研究情况，最后对文章组织结构和研究内容进行了概括。

第二章：对本文所使用的公开数据库MIMIC-IV、数据库的模块信息、数据提取的具体过程、数据预处理方法进行了详
细介绍。

第三章：介绍了本文所涉及的相关理论技术，包括了传统生存分析模型、机器学习生存模型、深度生存模型以及
生存分析评价指标。

第四章：将6种生存分析算法应用于从公开数据库中提取的数据中，对参数设置、模型训练与优化过程、指标评价结果
进行详细介绍，以此寻找在各方面评价标准下最优的ICU中肾功能衰竭患者死亡率评估模型。

第五章：对本研究ICU中肾功能衰竭患者死亡率预测的主要研究内容和应用进行总结，给出了研究结论，并说明了本
研究的不足，以及对未来研究给出建议。

\chapter{生存数据与研究方法}

本章主要是对本文所使用到相关技术进行理论介绍，包括生存分析的理论基础、本文所采用的生存分析模型以及生存分析的评估指标体系，
本文研究工作的开展是在这些技术基础上进行的。

%---------------------------------------
\section{生存分析基础}
%---------------------------------------
生存分析用于分析或预测事件何时可能发生。它起源于医学研究，但其用途已大大扩展到许多不同的领域。例如：
银行、贷方和其他金融机构使用它来计算偿还贷款的速度或借款人何时违约；企业采用它来计算客户的终身价值或
客户何时流失；公司用它来预测员工何时决定离开；工程师和制造商应用它来预测机器何时会损坏。
%---------------------------------------
\subsection{生存数据}
%---------------------------------------

\begin{figure}[bpht]
    \begin{center}
    \includegraphics[width=0.6 \columnwidth]{bodyfiguretables/survival_data_demo}
    \end{center}
    \caption{生存数据案例}
    \label{pcensordat}
\end{figure}

生存分析之所以
与传统普通的统计分析不同主要是在于其数据类型的区别，生存时间通常具有不精密的特点，即生存时间往往不是精确
的，在统计学中一般称为“删失”数据(Censored Data)\cite{Johnston12}。例如当研究某项临床实验研究时，该研究调查某种疾病的
预后情况并且确定实验为期6个月，如图\ref{pcensordat}所示。



患者 A 在进入项目的三个月后失访，没有记录疾病事件；患者 B 在入组后四个半月经历了一次研究的疾病事件，
并记录到了疾病发生的确切时间；患者C在入组后的三个半月退出研究；患者 D在入组后两个半月经历了一次研究
的疾病事件，并记录到了疾病发生的确切时间；患者E知道研究结束前都没有经历过任何事件。因此，在整个研究
过程中，只能有效地记录患者 B 和 D 的心血管事件的确切时间；他们的记录没有任何删失。然而对于其他患者，
他们在研究终止后是否经历过事件尚不清楚。可用于患者 A、C 和 E 的唯一有效信息是他们在最后一次随访前没有
发生事件。因此，他们的记录受到删失处理。

对于患者记录而言，每个患者都会由一组协变量$X\in R^d$和事件发生的时间$t>0$或被删失的时间$c>0$组成。
由于删失和事件是互斥的，所以通常定义为一个示性函数$\sigma\in\{0;1\}$ 和可观察的生存时间$y>0$。针
对这样的数据，如果尝试使用回归模型来预测事件可能发生的时间就需要忽略被删失的样本，这会导致重要信息的丢
失。但是生存模型能够考虑删失并结合这种不确定性，因此生存分析不是预测事件的时间，而是预测事件在特定时
间发生的概率。

%---------------------------------------
\subsection{生存函数}
%---------------------------------------

生存分析中的预测步骤不是专注于预测事件的单个时间点，而是专注于协变量与生存状态之间的潜在关系，这里的生存状态是指生存时间与研究事件状态的共同结果，
即预测一个函数：生存函数(Survival Function)或危险函数(Hazard Function)。

生存函数 $S\left(t\right)$ 是指生存时间$T$超出时间$t$的生存概率，即
\begin{equation}
    S\left(t\right)=Pr\left(T>t\right)
    \label{f1}.
\end{equation}

生存函数定义了感兴趣的事件(例如疾病的死亡、机器的损坏)在一段事件内没有发生的概率。

%---------------------------------------
\subsection{风险函数}
%---------------------------------------

风险函数(Hazard Function)又被称为条件故障率、条件死亡率或瞬时故障率。定义了在生存时间大于$t$的条件下
在t时刻触发事件的概率，故t时刻的风险函数$h\left(t\right)$可以表示为： 
\begin{equation}
    h(\mathrm{t}, \mathrm{X})=\lim _{\Delta \mathrm{t} 
    \rightarrow 0} \frac{\mathrm{P}(\mathrm{t}<\mathrm{T}
     \leq \mathrm{t}+\Delta \mathrm{t} \mid \mathrm{T} \geq
      \mathrm{t}, \mathrm{X})}{\Delta \mathrm{t}}
    \label{f1}.
\end{equation}%

一般而言风险函数难以估计，但是在生存过程中却起着很关键的作用。在临床治疗中，风险函数的图像形式表明了患者长期的生存
状态，上升的风险函数意味着随着年龄的增大患者的死亡率越大，下降的风险函数意味着随着年龄的增大患者的
死亡率越来越小。与生存函数描述事件没有发生的概率不同，风险函数描述的是事件将在此之前没有发生过的条件下，
将在单位时间内发生的条件概率。因此可以得到生存函数$S\left(t\right)$与风险函数$h\left(t\right)$之间的关系
如下：

\begin{equation}
    S\left(t\right)=\exp\left[\int_{0}^{t}h\left(z\right)dz\right]
    \label{f2},
\end{equation}
其中$H\left(t\right)=\int_{0}^{t}h\left(z\right)dz$表示累计风险函数(Cumulative Hazard Function,CHF)。

\subsection{参数估计}

怎样估算生存函数和风险函数是生存分析的主要问题,关于生存函数和风险函数的估算方法通常分为参数法和非参数法。
但如果事先了解生存时间的分布情况,可采用参数法:通过对样本观测值来计算假定的分布模型中的所有参数,从而得到
生存时间的概率分布模型。生存时间经常服从的分布有：指数分布、Weibull分布、对数正态分布、对数Logistic分布、Gamma分布。
其中韦布尔分布由于其参数的灵活性，常常用于描述机械零件失效数据的分布规律，在生存分析领域内广受欢迎 。其密
度函数为：
\begin{equation}
    f(t) \frac{m t^{m-1}}{\eta^{m}} \exp =\left[-\left(\frac{t^{m}}{\eta}\right)\right], t \geq 0
    \label{f2},
\end{equation}
其中$m$是形状参数，确定了密度函数的形状； $\eta$是刻度参数，确定了密度函数的位置。

参数法一般适用于样本量较少的情况，并且由于人们往往对实际数据的生存时间分布并不知道，所以所有参数估计都
并不是最适用的生存分析。在临床统计中，对于生存时间的总体分布情况认识一般并不全面，因此通常使用非参数的生存分析研究方法，如：寿
命表法、Kaplan-Meier法、Tnubull估计等。其中最常用的非参数估计方法是Kaplan-Meier法估计\cite{Kaplan58}，Kaplan-Meier给
出生存函数曲线的估计是：
\begin{equation}
    \hat{\mathrm{S}}_{\mathrm{km}}(\mathrm{t})=\prod_{\mathrm{s} \leq \mathrm{t}}\left[1-\frac{\Delta \mathrm{N}(\mathrm{s})}{\mathrm{Y}(\mathrm{s})}\right]
    \label{f3},
\end{equation}
其中$\Delta N\left(s\right)$表示恰好在t时刻死亡的人数，$Y\left(s\right)$表示$s$时刻仍然在观察队列的人数。
Kaplan-Meier法所计算得到的生存函数是一个下降的右连续的阶梯函数，因此可以证明当样本量足够大的情况下，
$\hat{S}_{KM}\left(t\right)$可以与$S\left(t\right)$任意接近。

按照风险函数的概念，只有当生存函数$S\left(t\right)$是可微分的情况下，风险函数才是有意义的。所以
Kaplan-Meier法并不会直接估计风险函数，而是需要通过累计风险函数$H\left(t\right)$进行估计，其对于累计风险函数
的估计是：
\begin{equation}
    \hat{H}_{\mathrm{KM}}(\mathrm{t})=-\ln \left(\hat{\mathrm{S}}_{\mathrm{KM}}(\mathrm{t})\right)=\sum_{\mathrm{s} \leq \mathrm{t}} \ln \left[1-\frac{\Delta \mathrm{N}(\mathrm{s})}{\mathrm{Y}(\mathrm{s})}\right]
    \label{f4}.
\end{equation}

%---------------------------------------
\section{生存分析统计模型}
%---------------------------------------
通过前文介绍的Kaplan-Meier方法，通过根据变量来将数据集划分为更小的亚组来估计多条生存函数曲线。但是当考虑
的变量超过1个的时候，由于亚组样本量会变得非常小因此这种方法就不再适用了。另外，在生存分析研究中的数据包含样本的删
失信息，以及其中的时间变量$t$通常不满足正态分布和方差齐性。所以不能直接以$S\left(t,X\right)$为因变量，以$X$为自变量进行
线性回归。为了估计每个变量对生存的影响，目前已经提出了大量生存分析的模型。
%---------------------------------------
\subsection{Cox比例风险模型}
%---------------------------------------

最早由英国统计学家Cox所提出Cox比例风险模型是对生存分析中的风险函数进行建模的一种半参数统计方法\cite{Cox72}。全称为Cox比例
风险回归模型(Cox Proportional Hazards Model,CPH)。CPH模型不是直接对$S\left(t,X\right)$与$X$进行回
归，而是将风险函数$h\left(t,X\right)$作为因变量，建立指数形式的回归方程：
\begin{equation}
    h(t,X)=h_0(t)\exp(\beta_1X_1+\beta_2X_2+...+\beta_mX_m)
    \label{f4.4},
\end{equation}
其中$\beta_1,\beta_2,\ldots,\beta_m$表示各个自变量的偏回归系数，$h_0\left(t\right)$是当$X$向量为零向
量时，风险函数$h\left(t,X\right)$的基准风险率。因为CPH模型未对$h_0\left(t\right)$作任何
假定，因此CPH模型在处理问题时具有较大的灵活性。在很多情况下，即使$h_0\left(t\right)$未
知，仍然能够估计出参数$\beta$，其意义在于将时间和危险因素对风险函数的影响分开，仅仅研究危险因
素对生存的影响，而不关心时间对生存的影响。

但CPH模型有两个很重要的假定条件，分别为比例风险假定和对数线性假定。比例风险假定是指各风险因子
的作用不随时间的变化而变化，即$\frac{h\left(t,X\right)}{h_0\left(t\right)}$不随时间的变化而变化，
因此，又称为比例风险假设。这一假定是建立CPH模型的前提假设。对数线性
假定是指对数风险比与模型中的自变量应与呈线性关系：
$g(x)=\ln \left[\mathrm{h}(\mathrm{t}, \mathrm{X}) / \mathrm{h}_{0}(\mathrm{t})\right]=\beta_{1} \mathrm{X}_{1}+\beta_{2} \mathrm{X}_{2}+\cdots+\beta_{\mathrm{m}} \mathrm{X}_{\mathrm{m}}$。

CPH模型对于参数的估计主要采用偏似然函数估计法，其对数似然函数如下：
\begin{equation}
    \l_{\text{cph}}(\beta)=\sum_{\mathrm{i}=1}^{\mathrm{N}} \sigma_{\mathrm{i}} \left[\beta \mathrm{X}_{\mathrm{i}}-\log \left(\sum_{\mathrm{j}: \mathrm{t}_{\mathrm{j}} \geq \mathrm{t}_{\mathrm{i}}} \exp \left(\beta \mathrm{X}_{\mathrm{j}}\right)\right)\right],
  \label{f5}
\end{equation}%
其中$\sigma_{\mathrm{i}}=\mathrm{I}\left(\mathrm{T}_{\mathrm{i}} \leq \mathrm{C}_{\mathrm{i}}\right)$，表示数据是否删失的示性函数。
进而得到其偏似然函数被定义如下：
\begin{equation}
    L_{cph}(\beta)=\prod_{i=1}^{N}\left[\frac{\exp \left(\beta X_{i}\right)}{\sum_{j: t_{j} \geq t_{i}} \exp \left(\beta X_{j}\right)}\right]^{\sigma_{i}}.
    \label{f6}
\end{equation}%

若$X_j$是非暴露组观察对象的各变量取值，$X_i$是暴露组观察对象的各变量取值，可以求出暴露组对非暴露组的相对危险
度(Relative Risk,RR)：
\begin{equation}
    R R=\frac{h_{i}(t)}{h_{j}(t)}=\frac{h_{0}(t) \operatorname{\exp}\left(X_{i} \beta\right)}{h_{0}(t) \operatorname{\exp}\left(X_{j} \beta\right)}=\operatorname{\exp}\left[\left(X_{i}-X_{j}\right) \beta\right].
    \label{f7}
\end{equation}

假设协变量$X_i$的取值为$0 \text{、}1$分别代表暴露于危险因素和未暴露于危险因素，且维持其他协变量不变，则：
\begin{equation}
    \frac{\mathrm{h}\left(\mathrm{t} \mathrm{x}_{\mathrm{i}}=1\right)}{\mathrm{h}\left(\mathrm{t} \mathrm{x}_{\mathrm{i}}=0\right)}=\operatorname{\exp}\left(\beta_{\mathrm{i}}\right).
    \label{f8}
\end{equation}

所以$\exp\left(\beta_i\right)$可以表示受$X_i$影响和不受$X_i$影响的RR：当$RR>1$时，患者暴露于$X_i$的相对风险大于
不暴露$X_i$的相对风险，此时称$X_i$为风险因素(Risk Factor)； 当$RR<1$时，患者暴露于$X_i$的风险低于不暴露$X_i$的风险，此
时称$X_i$为保护因素(Protective Factor)；当$RR=1$时，患者暴露于$X_i$的风险与不暴露$X_i$的风险相等，此时称$X_i$对患
者的风险没有影响。因此估计得到的偏回归系数$\beta_j$具有重要的价值意义，其解释了危险因素$X_i$对相对危险度的影响。

%---------------------------------------
\subsection{Cox弹性网模型}
%---------------------------------------

在数据量还较少的情况下，应用的数据场景大都是$n>p$，即样本量大于变量数，此时CPH模型能够较好地应用在大多
数场景。然而随着数据量的剧增，模型纳入的协变量越来越多，且变量之间的相关性可能使得数据矩阵变成一个非奇异
矩阵，CPH模型便不再能够处理这种情况。为了解决这个问题，可以通过在系数上添加一个罚项来来缩减变量系
数，使得某些不太重要的变量系数接近$0$或等于$0$。常见的添加惩罚项包含如下三种方式。

当惩罚项为$L1$范数时，为Cox-Lasso回归\cite{Tibshirani97}，也称为Cox套索回归。添加后$L1$惩罚项能够将系数缩小到接近$0$附近
。修改后的偏对数似然函数为：
\begin{equation}
    pl_{\text {pen }}(\beta)= \l_{\text{cph}}(\beta) +\alpha \sum_{j=1}^{p}\left|\beta_{j}\right|,
    \label{f9}
\end{equation}
其中等式右边的前部分实际上是CPH模型的偏似然函数\ref{f5}，而后半部分$\sum_{j=1}^{p}\left|\beta_j\right|$便是
引入的$L1$惩罚项。$\alpha$是一个控制其惩罚力度的系数，当$\alpha$越大，则惩罚力度越大，当$\alpha$越小，惩罚
力度越小。

虽然Cox-Lasso回归不能直接控制选择的特征数量，但是通过$\alpha$的值却可以隐式地判断最佳特征数量，
通过调整$\alpha$的值使得变量系数不断变化，同时当变量系数缩小为$0$时便能够对该变量进行过滤。因此对于
Cox-Lasso回归的重要功能便是特征筛选，减少进行训练或预测的特征数量。然而Cox-Lasso回归对于过度拟合训练
数据的特征信息却无能为力，但这正是下面要介绍的Cox-Ridge回归的特点。

Cox-Ridge回归也称为Cox岭回归\cite{Perperoglou13}，通过$L2$惩罚来替换Cox-Lasso回归中的 $L1$惩罚项，当惩罚项为$L2$范数时，其偏对
数似然函数如下：
\begin{equation}
    p l_{\text {pen }}(\beta)=\l_{\text{cph}}(\beta) +\frac{\alpha}{2} \sum_{j=1}^{p} \beta_{j}^{2}
    \label{f10}.
\end{equation}

上式相对于Cox-Lasso的偏对数似然函数的差异仅为惩罚项为L2范数。但是由于其系数缩小只是接近零而不会使系数等
于$0$，使得Cox-Ridge回归具有了防止模型过拟合、增强模型的泛化能力的功能，但是其不能进行特征子集的选择。而想要
同时囊括Cox-Lasso回归与Cox-Ridge回归的功能优势，则可以使用Cox-ElasticNet回归。

Cox-ElasticNet回归也叫做Cox弹性网回归\cite{Suchting19}，通过添加L1和L2范数惩罚的加权组合解决了这些问题，其得到的偏对数似然函数如下：
\begin{equation}
    p l_{p e n}(\beta)=\log L(\beta)=  \l_{\text{cph}}(\beta)  +\alpha \sum_{j=1}^{p}\left|\beta_{j}\right|+\frac{1-\alpha}{2} \sum_{j=1}^{p} \beta_{j}^{2},
    \label{f11}
\end{equation}
其中 $\alpha\in\left[0;1\right]$ 是$L1$和$L2$惩罚的相对权重。Cox-ElasticNet回归惩罚结合了Cox-Lasso回归的子集选择
属性和Cox-Ridge惩罚的正则化强度，与Cox-Lasso回归模型相比具有更好的稳定性。对于一组高度相关的特征，后者会随
机选择一个特征，而 Cox-ElasticNet惩罚模型倾向于选择所有特征。

 
%---------------------------------------
\subsection{随机生存森林模型}
%---------------------------------------
随机生存森林(Random Survival Forest,RSF)\cite{Ishwaran08}是对Breiman随机森林\cite{Breiman01}的扩充，是一种用来
对右删失生存数据进行分类或回归的随机森林方法。其最基本的训练建树规律和随机森林很相似，
首先通过抽取Bootstrap选取训练样本用来建树\cite{Efron79}。然后在建树的过程中，从各个节点随机选
取部分预测变量作为分类该节点的候选变量，并按照包含生存时间和生存删失信息的生存标准进行分类。
具体的随机森林算法步骤如下：
\begin{enumerate}
\item 通过Bootstrap抽样法，从原始数据中抽取部分样本作为训练样本。Bootstrap抽样结果中大约会有三分之二的样本被抽取出来，
剩余三分之一的样本被定义为包外数据。

\item 利用训练样本建立生存树。在树的每个节点，随机抽取$q$个候选变量，在$q$个候选变量中，选择能够使子节点的生存情
况差别最大的变量作为该节点的分类变量。

\item 重复步骤(2)并继续向下构建树模型，直至根节点拥有最少的但是至少有一个死亡事件。

\item 对每棵树计算其累积风险函数，从而获得整个森林的累积风险函数。

\item 利用包外数据，评估该累积风险函数的袋外预测错误率，并计算每个预测变量的重要性评分。
\end{enumerate}

%---------------------------------------
\subsection{DeepSurv模型}
%---------------------------------------
DeepSurv模型是由Katzman在Faraggi-Simon网络的基础上加以推广的多层感知机模型\cite{Katzman18}，其采用较新的深度学习
技术，包括：权重衰减正则化、整流线性单元、皮归一化、SELU、
DropOut、梯度下降优化算法(Stochastic Gradient Descent and Adaptive Moment Estimation,
 Adam)、动量、梯度裁剪、学习率调度等。通过向网络中添加其他可自定义的多个隐含层来改变网络结构，以此将深度网
  络的输入层的协变量作为CPH模型的输入，输出层设置为一个节点作为CPH模型的危险函数。该网络设置
  一个输出节点，输出节点可以被看做CPH模型的危险函数$h(x)$。其网络模型训练的损失函数为负
  对数偏私然函数：
\begin{equation}
    \mathrm{l}(\theta)=-\sum_{\mathrm{i}, \mathrm{E}_{\mathrm{i}}=1}\left[\hat{\mathrm{h}}_{\theta}(\mathrm{x})-\log \sum_{\mathrm{j} \in \mathcal{R}\left(\mathrm{T}_{\mathrm{i}}\right)} \mathrm{e}^{\hat{\mathrm{h}}_{\theta}\left(\mathrm{x}_{\mathrm{j}}\right)}\right],
    \label{f12}
\end{equation}
其中$\theta$为网络模型的权重参数。所以DeepSurv也可以被认为是CPH模型结合神经网络的一个拓展模型。

%---------------------------------------
\subsection{Cox-CC模型}
%---------------------------------------
Kvamme等人提出了将线性预测的对数风险函数$g(x)$替换为由神经网络参数化，以此来扩展普通的神经网络
Cox模型，称为非线性神经网络参数化Cox模型，也称为Cox-CC模型\cite{Kvamme19}。此外，对于非比例的神经网络Cox模型而言，
批量迭代方式在计算上需要占用大量的计算资源。因此Cox-CC模型采用的是小批量迭代损失函数的近似值，以此来
解决批量迭代的运算问题。

即通过一个足够大的子集$\tilde{R_i}$来近似批量迭代中的风险集$R_i$，并用权重$w_i$对似然函数进行加
权，使得风险集$R_i$在下式损失函数中的加权和是风险集$R_i$不进行加权的损失函数的近似值。

\begin{equation}
    L=\prod_{t}\left[\frac{\exp \left[g\left(\mathbf{x}_{1}\right)\right]}{w_{i} \sum_{j \in k_{i}} \exp \left[g\left(\mathbf{x}_{j}\right)\right]}\right]^{D_{i}}
    \label{f13}.
\end{equation}

通过选取风险子集$\tilde{R_i}$的样本量可以通过分批梯度下降的方法来优化目标损失函数。而在中，在上式中的
权重实际上对梯度下降的过程并不会产生影响，因此完全可以将其从目标损失函数中剔除。最终对损失函数进行平均以
此来避免数据集中发生时间的数量$n$对损失函数照成影响，得到如下损失函数：

\begin{equation}
    \operatorname{loss} =\frac{1}{n} \sum_{i: D_{i}=1} \log \left[\sum_{j \in \widetilde{\mathcal{R}}_{i}} \exp \left[g\left(\mathbf{x}_{j}\right)-g\left(\mathbf{x}_{i}\right)\right]\right].
    \label{f13}
\end{equation}

进一步，实际上从风险子集$\tilde{R_i}$中取一个个体j是同样的结果。因此，进一步修正后的损失函数为：
\begin{equation}
    \operatorname{loss}=\frac{1}{n} \sum_{t: D=1}\log \left(1+\exp \left[g\left(\mathbf{x}_{j}\right)-g\left(\mathbf{x}_{t}\right)\right]\right), \quad j \in \mathcal{R} \backslash\left\{\boldsymbol{r}{\}}\right..
    \label{f14}
\end{equation}

因为选取的风险子集$\tilde{R_i}$是一个固定的容量，因此，尽管上式对偏对数使然函数进行了平均，但其仍
然不对受到批次大小选择的影响。此外，对于Cox-CC模型而言，损失不一定具有对数风险函数的唯一最小值。因此，
在Cox-CC模型中对损失添加了一个惩罚项$\sum_{i:D_j=1}\sum_{j\in{\tilde{\mathcal{R}}}_i}\left|g\left(\mathbf{x}_\mathbf{j}\right)\right|$
使得对数风险函数能够尽可能的靠近$0$附近。


%---------------------------------------
\subsection{Cox-Time模型}
%---------------------------------------
为了规避CPH模型的比例假设条件，Kvamme提出了一种不需要分层的参数化方法，以此来解决不符合比例假设的
问题，称为非比例Cox-Time模型\cite{Kvamme19}。Cox-Time模型通过让相对风险函数$g(x)$
取决于时间来建模：
\begin{equation}
    h(t \mid \mathbf{x})=h_{0}(t) \exp [g(t, \mathbf{x})].
    \label{f15}
\end{equation}

此时，模型不再是比例风险模型，但是仍然是一个相对风险模型。因此具有和CPH相似的偏对数似然函数，只是
在其中掺杂了协变量因素。此外也对Cox-Time模型进行小批量迭代的方式处理和添加惩罚项进行处理，具体的处理
方式同Cox-CC模型。最终得到的损失函数为：
\begin{equation}
    \operatorname{loss}=\frac{1}{n} \sum_{i: D_{i}=1} \log \left[\sum_{j \in \widetilde{\mathcal{R}}_{i}} \exp \left[g\left(T_{i}, \mathbf{x}_{j}\right)-g\left(T_{i}, \mathbf{x}_{i}\right)\right]\right].
    \label{f16}
\end{equation}

在预测方面由于Cox-Time模型规避了比例假设的条件，导致计算开销上更大。其相对风险是关于时间的函数，因此需
要对基准风险函数$h_0(x)$与$g(t,X)$进行积分计算累计风险函数$H(t|X)$：
\begin{equation}
    H(t \mid \mathbf{x})=\int_{0}^{t} h_{0}(s) \exp [g(s, \mathbf{x})] ds.
    \label{f17}
\end{equation}

而在实际中可以通过下式计算累计风险函数：
\begin{equation}
    \hat{H}(t \mid \mathbf{x})=\sum_{T_{i} \leq t} \Delta \hat{H}_{0}\left(T_{i}\right) \exp \left[\hat{g}\left(T_{i}, \mathbf{x}\right)\right].
    \label{f18}
\end{equation}
其中$\Delta\hat{H}_0$是Breslow估计的增量，而$\hat{g}\left(T_i,x\right)$是从神经网络中获
得的$g\left(T_i,x\right)$的估计。

%---------------------------------------
\subsection{LogisticHarzad模型}
%---------------------------------------
由于连续时间的数据收集较为困难，因此相对于连续数据，离散时间生存模型是更常见的。LogisticHazard模型是
Kvamme提出基于神经网络的离散时间生存分析方法\cite{Kvamme21}。在模型中引入了两种离散化的方法，对应于等距时间或等距边际生
存概率，以及两种插值离散时间预测的方法对应于分段常数密度函数或分段常数危险率。

在离散时间回归问题中，生存时间$T$具有离散分布$0<t_1<t_2<\ldots$，令$T=\{t_1,t_2,\ldots\}$表示离散时间的集
合。研究目标是在给定协变量向量$X$的情况下对该事件时间的条件分布进行建模。因此，对于事件时间的概率质量函
数和生存函数定义如下：
\begin{equation}
    f\left(\tau_{j} \mid \mathbf{x}\right)=\mathrm{P}\left(T^{*}=\tau_{j} \mid \mathbf{x}\right),
    \label{f19}
\end{equation}
\begin{equation}
    S\left(\tau_{j} \mid \mathbf{x}\right)=\mathrm{P}\left(T^{*}>\tau_{j} \mid \mathbf{x}\right)=\sum_{k>j} f\left(\tau_{k} \mid \mathbf{x}\right).
    \label{f20}
\end{equation}

对于离散时间，危险率定义为：
\begin{equation}
    h\left(\tau_{j} \mid \mathbf{x}\right)=\mathrm{P}\left(T^{*}=\tau_{j} \mid T^{*}>\tau_{j-1}, \mathbf{x}\right)=\frac{f\left(\tau_{j} \mid \mathbf{x}\right)}{S\left(\tau_{j-1} \mid \mathbf{x}\right)}.
    \label{f21}
\end{equation}

进而可以推导得出离散时间的生存函数：
\begin{equation}
    S\left(\tau_{j} \mid \mathbf{x}\right)=\prod_{k=1}^{j}\left[1-h\left(\tau_{k} \mid \mathbf{x}\right)\right].
    \label{f22}
\end{equation}

当考虑一组$n$个独立个体，每个个体具有协变量$X$、事件状态、删失事件的数据，其平均负对数似然如下：
\begin{equation}
    \operatorname{loss}=-\frac{1}{n} \sum_{i=1}^{n}\left\{d_{i} \log \left[f\left(t_{i} \mid \mathbf{x}_{i}\right)\right]+\left(1-d_{i}\right) \log \left[S\left(t_{i} \mid \mathbf{x}_{i}\right)\right]\right\}.
    \label{f23}
\end{equation}

通过使上式损失函数最小化，可以通过参数化概率质量函数或离散风险率并最小化相应的损失函数来建立生存模型。
然后通过使用神经网络参数化概率质量函数或离散风险率来创建生存预测模型。





%---------------------------------------
\section{模型评价指标}
%---------------------------------------
用于评估事件时间预测方法的性能的指标应考虑被删失的个人。在下面，描述了几种本研究所用的评价指标。

%---------------------------------------
\subsection{一致性指数}
%---------------------------------------
生存模型中最常用的评价指标是一致性指数(Concordance Index,C-Index),简称C指数\cite{Harrell82}，它是预测风险评分$\hat{f}$和观察到的时间点$y$之间
等级相关性的度量， 与Kendall 的$\tau$密切相关。它被定义为正确排序对(一致)与可比较对的比率。
如果具有较低观察时间$y$的样本经历了一个事件，即如果$y_j>y_i$和$\delta_i=1$，则两个样本
 $i$和 $j$是可比较的，其中 $\delta_i$ 是二元事件指示器。如果生存模型的估计风险 $\hat{f}$对于生
 存时间较短的受试者较高，即 $\widehat{f_i}>\widehat{f_j}\land y_j>y_i$，否则这对是不一致的。虽
 然Harrell的一致性指数易于解释和计算，但是也有一些缺点：首先是随着删失率的增加，一致指数的结果往往会
 偏于乐观方向。其次是一致指数无法对特定时间点的模型效果进行评价。

%---------------------------------------
\subsection{时间依赖一致性指数}
%---------------------------------------

将一致指数应用于非比例风险模型尚不明确。我们将使用基于2004年Heagerty等人的时间依赖性C指数来度量\cite{Patrick05}。
它估计了观测值$i$和$j$一致的可能性:
\begin{equation}
    C^{\mathrm{td}}=\mathbf{P}\left\{\hat{S}\left(T_{i} \mid \mathbf{x}_{\mathbf{i}}\right)<\hat{S}\left(T_{i} \mid \mathbf{x}_{\mathbf{j}}\right) \mid T_{i}<T_{j}, D_{i}=1\right\}.
    \label{f24}
\end{equation}%

对于比例风险模型，此指标等同于常规C指数。一般情况下，越大的$C^{td}$意味着模型的区分能力越强，模型性能更好。


%---------------------------------------
\subsection{时间依赖ROC曲线}
%---------------------------------------
在传统的ROC(Receiver Operator Characteristic)曲线中，个体的事件状态随着时间的推移是固定的。但在临床流行病学研究中，疾病状
态都是随着时间的推移而变化的。早期无病的个体由于研究随访时间较长，也可能较晚患病甚至不患病。如果采用传统的ROC曲线会忽
略疾病状态或重要变量的时间依赖性，此时可以通过将ROC曲线扩展到可能的删失生存时间来解决，即时间依赖ROC曲线(ROC-Time)。

在医学领域，它通常用于确定估计的风险评分如何将病例与对照区分开来。当将ROC曲线扩展到连
续结果时，特别是生存时间，患者的疾病状态通常不是固定的，而是会随着时间而变化\cite{Kamarudin17}。因此，敏感性和特异性成为
时间依赖性测量。考虑给定时间点$t$的累积病例情况和动态事件状态，这会在时间 $t$产生与时间相关的累积/动态ROC曲
线。累积病例是在 $t(t_i\le t)$之前或当时经历过事件的所有个体，而动态事件状态是那些具有$t_i>t $的个体。
通过计算在时间$t$的累积/动态ROC曲线下的面积，可以确定模型在给定时间$t_i\le t$内失败的受试者与在此之后失败
的受试者的区分程度时间 $t_i\le t$。

一般而言，因素测量时间距离时间发生时间越远，其预测能力就可能变得越弱。时间依赖性ROC曲线的主要优势在于它
能够利用每个患者发病时间的附加信息，从而能够在多个时间点构建ROC曲线，并比较因素的预测能力。这能够使我们知
道在多长的时间范围内我们进行生存分析是有效的，以及在这个时间范围内如何对连续型变量进行分组是最恰当的。


%---------------------------------------
\subsection{BS评分}
%---------------------------------------

虽然一致性指数是最常见的区别度衡量标准。然而，一致性指数忽略了预测风险评分的实际值并且无法告诉我们任何有
关校准的信息。Brier Score(BS)评分通常用于模型估计的区分和校准的度量指标，如果模型预测在时间 $t$发生事
件的风险为 $10\%$，则数据中观察到的频率应与校准良好的模型的该百分比相匹配。对于概率$y_i=1$的概率的$N$个二元
标签$y_i\in\{0,1\}$，BS评分的计算方式是概率估计$\widehat{p_i}$的均方误差，即：

\begin{equation}
    \mathrm{BS}=\frac{1}{N} \sum_{i}\left(y_{i}-\widehat{p}_{\imath}\right)^{2}
    \label{f25}
\end{equation}%

此外，BS评分也是一种区分度的衡量标准：模型是否能够预测风险评分，从而使我们能够正确确定事件的顺序。

%---------------------------------------
\subsection{IBS}
%---------------------------------------
为了从事件发生时间数据中得出二元结果，选择一个固定的时间$t$并根据一个人的发生事件时间是否短于$t$来标记数据。
 为了解释删失信息， Graf等人根据反向删失分布对得分进行加权\cite{Graf99}来将BS评分进行泛化：
\begin{equation}
    \mathrm{BS(t)}=\frac{1}{N} \sum_{i=1}^{N}\left[\frac{\hat{S}\left(t \mid \mathbf{x}_{\mathbf{i}}\right)^{2} I\left\{T_{i}
     \leq t, D_{i}=1\right\}}{\hat{G}\left(T_{i}\right)}+\frac{\left(1-\hat{S}\left(t \mid 
     \mathbf{x}_{\mathbf{i}}\right)\right)^{2} I\left\{T_{i}>t\right\}}{\hat{G}(t)}\right]
    \label{f26}
\end{equation}%
此处$N$代表样本观察数，$\hat{G}\left(t\right)$是生存函数的Kaplan-Meier估计值$P\left(C^\ast>t\right)$，并且假定删失时间和生存时间
是独立的。通过计算集成的BS评分，可以将BS评分从单个持续时间 $t$ 延申到一个时间间隔：
\begin{equation}
    \mathrm{IBS}=\frac{1}{t_{2}-t_{1}} \int_{t_{1}}^{t_{2}} \mathrm{BS}(s)ds
    \label{f27}
\end{equation}%


%---------------------------------------
\chapter{数据来源与清洗}
%---------------------------------------

生物医学领域的生存分析的研究离不开丰富的数据，因此高质量的临床患者数
据集的收集与整理是至关重要的一步。本章节是对本文所使用的数据集
来源、收集过程以及它的预处理方式等进行详细的介绍。


%---------------------------------------
\section{数据来源}
%---------------------------------------
危重症监护数据库(Medical Information Mart for Intensive Care Database, MIMIC
https://physionet.org/content/mimiciv/1.0/)是美国麻省理工学院发布的一个多参数、结构化的单中心
重症监护数据库。数据库中详细收录了美国波士顿BID医学中心重症监护病房的十余年的临床诊断信息\cite{Goldberger00}。

MIMIC-III发布于2015年底，包含了49785例患者的入院信息，并记录了从2001年至2012年之间合计53423例ICU患者
的住院记录。在2020年8月，开发团队发布了MIMIC-IV版本，该版本为MIMIC-III的跟新版本，包含了当前已有的
数据并在MIMIC-III的许多方面进行了改进。MIMIC-IV更新了2008年至2019年期间美国BID医院数据库中入住急
诊科或进行重症监护病房的患者的临床数据，并采用了一种模块化的数据组织方法，突出了数据来源，促进了对不同
数据源的单独和联合使用。

MIMIC-IV当前的最新版本为v1.0，此版本在2021年3月16日发布，这也是目前MIMIC-IV数据库的最终版本。因此，本
文实验是基于MIMIC-IV v1.0进行的，以下文章中均简称为MIMIC-IV。在MIMIC-IV中分为6个模块：
core、hosp、icu、ed、cxr、note。


core模块存储MIMIC-IV进行任何数据分析说需要的患者跟踪信息，其中包含3个表，这些表提供了患者的人口统计数
据、每次住院的记录和住院期间的每个病房的记录。hosp模块包含来自医院范围内的HER的数据，这些测量数据主要为
患者住院期间的记录值，但也有部分来自院外的数据，例如实验室活动中的门诊实验室检测等。icu模块包含了BIDMC临床
信息系统的数据，记录在案的数据包括静脉给药、呼吸机设置和其他图表项目等。ed模块包含急诊诊断，病人体征
等信息。通过subject\_id和hadm\_id与其他模块相连接。急诊的患者如有hadm\_id，则说明该患者住院治疗。ed患
者不一定住院，住院的患者也不一定从急诊入院。cxr模块则是X光胸片文件，源数据是dicom格式，但也提供了jpg
格式的下载。包含了胸片及影像学报告。值得注意的是，存在有影像的患者没有住院记录的情况。Note模块目前并没
有公开，模块中的内容是所有文本报告，出院、超声、新店、影像等报告。本文实验只收集了core、hosp、icu、ed
中的数据，其他模块中的数据并未涉及。关于core、hosp、icu、ed模块中的具体表格解释详见表\ref{mimic_shame_info}。

{
\small
\begin{longtable}{>{\centering}p{0.15\columnwidth}>{\centering}p{0.15\columnwidth}>{\centering\arraybackslash}p{0.5\columnwidth}}

    \caption{MIMIC-IV数据库中主要模块基本描述信息}
    \label{mimic_shame_info} \\

    \toprule
    \textbf{模块} & \textbf{表名}   & \textbf{描述} \\                              
	\midrule  %这一条线是三线表中间的细线
	\endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
	\multicolumn{3}{r}{续表}\\      %4表示有4列
	\toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{模块} & \textbf{表名}   & \textbf{描述} \\                              
	\midrule      %这条命令表示假如跨页，续页的三线表中间的细线
	\endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
	\bottomrule    % 这一条线是三线表最底下的又黑又粗的线
	\multicolumn{3}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
	\endfoot % 以上表示除表格最后一页其他页的表尾
	\bottomrule %三线表最底下的又黑又粗的线
	\endlastfoot %最后一页的表尾

    core        & admission            & 患者入院信息                                            \\
    core        & patient              & 患者信息                                              \\
    core        & transfers            & 病房转移信息                                            \\
    hosp        & d\_icd\_diagnoses    & {\color[HTML]{2E3033} 包含国际疾病分类(ICD)第9版和第10版的诊断代码} \\
    hosp        & diagnoses\_icd       & 患者诊断信息表                                           \\
    hosp        & drgcodes             & 诊断相关的表                                            \\
    hosp        & d\_icd\_procedures   & 患者住院期间的手术信息                                       \\
    hosp        & procedures\_icd      & 患者住院期间的手术信息                                       \\
    hosp        & d\_labitems          & 实验室检查定义表                                          \\
    hosp        & labevents            & 病人实验室检查的记录                                        \\
    hosp        & prescriptions        & 药物处方数据                                            \\
    hosp        & pharmacy             & 药房数据表                                             \\
    icu         & d\_items             & 包含ICU内发生的所有项目的编码                                  \\
    icu         & icu\_stays           & 入住ICU的时间信息                                        \\
    icu         & chartevents          & {\color[HTML]{2E3033} 病人可用的所有图表数据}                \\
    ed          & diagnosis       & {\color[HTML]{2E3033} 为患者提供诊断列表}                  \\
    ed          & edstays         & {\color[HTML]{2E3033} 急诊科来访的主要跟踪表}                \\
    ed          & medrecon        & {\color[HTML]{2E3033} 医疗检查表}                      \\
    ed          & pyxis           & {\color[HTML]{2E3033} 提供了通过pyxis系统配制药物的信息。}       \\
    ed          & triage          & {\color[HTML]{2E3033} 包含病人在急诊室第一次分诊时生命体征信息}       \\
    ed          & vitalsign       & {\color[HTML]{2E3033} 生命体征表}                      \\
    ed          & vitalsign\_hl7 & 通过遥测技术检测的生命体征表                                    \\ 

    \end{longtable}

}

% %---------------------------------------
% \section{分析说明}
% %---------------------------------------

在文本实验中使用到的软件有PostgreSQL与Navicat Premium 15用于原始数据的收集加载与初步整理。用于数据的
进一步处理和、分析、建模以及可视化的编译环境为Python3.7，编辑器为PyCharm与Anaconda。关于数据在python
中的数据处理主要使用的是pandas、sklearn、sklearn\_pandas、psycopg2、pickle等包。本研究的深度学习模型
是在Torch的框架下搭建的。

MIMIC-IV数据库虽然进行了模块化分组，同时为了保护患者隐私安全对数据进行了去识别化和格式转换等。研究者在
使用数据之前需要申请并参加相应测试后待官方审批后才可对数据库进行使用，在本文实验开展之前已经获得MIMIC数
据库的使用权限。

关于数据库数据的提取以及预处理MIMIC官方推荐的软件为PostgreSQL，并创建了一个开源的代码库。其中官方提供
了将MIMIC-IV下载到的CSV文件加载到SQL数据库中的公用代码，同时也提供了一些常用分析表格的视图代码。因此，
本文在数据的收集与加载过程中均采用了官方提供的SQL代码。此外在PostgreSQL数据库中使  用也自编的SQL语句
对原始数据进行了初步整理。关于数据整理、模型分析、结果可视化的核心代码详见附录\ref{sqlcodes}。

%---------------------------------------
\section{指标体系构建}
%---------------------------------------

\begin{figure}[htb]
    \begin{center}
    \includegraphics[width=0.6\columnwidth]{bodyfiguretables/data_abstrct_flew}
    \end{center}
    \caption{数据采集流程框架图}
    \label{data_abstrct_flew}
\end{figure}

本文实验提取数据的流程如图\ref{data_abstrct_flew}所示。

首先筛选患有肾功能衰竭相关病症的数据。以“kidney failure”、“renal failure”、“Kidney failure”、“Renal failure”作为
检索关键词，且不包括“complicated by renal failure”关键词，在MIMIC-IV数据库种进行全局疾病检索。查
找到MIMIC-IV数据库中共存在26种不同类型的肾功能衰竭类疾病，其中包括ICD-9、ICD-10编码，具体的疾病
类型如表\ref{mimic_diease_type_info}所示。由于本文是针对所有肾功能衰竭类疾病进行分析，故将这26种疾病都作为
研究的目标疾病。

{
\small
\begin{longtable}{>{\centering}p{0.15\columnwidth}>{\centering}p{0.15\columnwidth}>{\centering\arraybackslash}p{0.5\columnwidth}}

    \caption{MIMIC-IV数据库中肾功能衰竭疾病类型表}
    \label{mimic_diease_type_info} \\
    
    \toprule
    \textbf{ICD编码} & \textbf{ICD版本} & \textbf{疾病类型}  \\                            
	\midrule  %这一条线是三线表中间的细线
	\endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
	\multicolumn{3}{r}{续表}\\      %4表示有4列
	\toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{ICD编码} & \textbf{ICD版本} & \textbf{疾病类型}  \\                               
	\midrule      %这条命令表示假如跨页，续页的三线表中间的细线
	\endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
	\bottomrule    % 这一条线是三线表最底下的又黑又粗的线
	\multicolumn{3}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
	\endfoot % 以上表示除表格最后一页其他页的表尾
	\bottomrule %三线表最底下的又黑又粗的线
	\endlastfoot %最后一页的表尾
    
    5845           & 9              & {\color[HTML]{333333} 急性肾衰竭伴肾小管坏死}             \\
    5846           & 9              & {\color[HTML]{333333} 伴有肾皮质坏死的急性肾衰竭}           \\
    5847           & 9              & {\color[HTML]{333333} 急性肾衰竭伴肾髓质乳头状坏死病变}        \\
    5848           & 9              & {\color[HTML]{333333} 急性肾衰竭伴肾脏其他特定病理病变}        \\
    5849           & 9              & {\color[HTML]{333333} 急性肾衰竭，未指明}               \\
    586            & 9              & {\color[HTML]{333333} 肾功能衰竭,不明}                \\
    6393           & 9              & {\color[HTML]{333333} 流产、异位妊娠和臼齿妊娠后的肾衰竭}       \\
    66930          & 9              & {\color[HTML]{333333} 急性肾衰竭后的分娩和分娩，不确定的插曲或不适用} \\
    66932          & 9              & {\color[HTML]{333333} 分娩后急性肾衰竭，分娩时，有产后并发症}     \\
    66934          & 9              & {\color[HTML]{333333} 急性肾衰竭后分娩，产后条件或并发症}       \\
    N17            & 10             & {\color[HTML]{333333} 急性肾功能衰竭}                 \\
    N170           & 10             & {\color[HTML]{333333} 急性肾衰竭伴肾小管坏死}             \\
    N171           & 10             & {\color[HTML]{333333} 急性肾衰竭伴急性皮质坏死}            \\
    N172           & 10             & {\color[HTML]{333333} 急性肾衰竭伴髓质坏死}              \\
    N178           & 10             & {\color[HTML]{333333} 其他急性肾衰竭}                 \\
    N179           & 10             & {\color[HTML]{333333} 急性肾衰竭，未指明}               \\
    N19            & 10             & {\color[HTML]{333333} 未指明的肾功能衰竭}               \\
    N990           & 10             & {\color[HTML]{333333} 术后(急性)(慢性)肾衰竭}           \\
    O0332          & 10             & {\color[HTML]{333333} 不完全自然流产后的肾功能衰竭}          \\
    O0382          & 10             & {\color[HTML]{333333} 完全或不确定的自然流产引起的肾功能衰竭}     \\
    O0482          & 10             & {\color[HTML]{333333} (诱导)终止妊娠后的肾功能衰竭}         \\
    O0732          & 10             & {\color[HTML]{333333} 试图终止妊娠失败后的肾衰竭}           \\
    O084           & 10             & {\color[HTML]{333333} 异位妊娠和磨牙妊娠后肾衰竭}           \\
    O904           & 10             & {\color[HTML]{333333} 产后急性肾衰竭}                 \\
    P960           & 10             & {\color[HTML]{333333} 先天性肾衰}                   \\ 


    \end{longtable}
}

根据这26种肾功能衰竭类疾病共提取57152条数据，由于同一名患者可能有多次入院情况，故其中包括33490名
患者。由于每位患者可能包含多种疾病，为了确认肾功能衰竭为患者的主要病症，即本文研究的是主要因患者患肾功能衰竭而入
院甚至死亡的全因死亡率。因此，统计了MIMIC-IV数据库中，以患者疾病次序为基础统计肾功能衰竭为该患者的前三主断疾病。
如图\ref{plot_disease_seq_count}所示，以肾功能衰竭为的诊断次序为横轴绘制条形图。可以看出，肾功能衰竭为第一次序主断疾病的超过5000例、第二次
序主断疾病超过17500例，第三次序主断疾病超过12500例，虽然作为第四次序主断疾病仍然存在大量病例，但考虑到此时肾功能
衰竭症诊断次序已然靠后，且伴随的其他挣断次序靠前的合并症可能出现严重不良事件，同时以肾功能衰竭为主要病症的前3位占
据了总诊断患者人数的65.84\%，由此可以说明提取的诊断次序位前3的肾功能衰竭患者数据可以作为本文的研究数据。

\begin{figure}[t]
    \begin{center}
    \includegraphics{bodyfiguretables/plot_disease_seq_count}
    \end{center}
    \caption{肾功能衰竭患者诊断次序次序直方图}
    \label{plot_disease_seq_count}
\end{figure}

筛选肾功能衰竭病症位于前3诊断次序的数据共有37613条，其中包括23853名患者。尽管目前已筛选出全为肾功能衰竭
患者，但仍然存在着许多子类的疾病类型。考虑到如果疾病类型分布太过离散，导致各种类型的肾功能衰竭的病因分布
异质差异较大，对分析结果可能产生影响。因此查看目前已筛选的所有肾功能衰竭疾病类型与患者数量，结果如表\ref{diease_type_with_count}显
示。发现主要的入院疾病类型为急性肾衰竭，且在入院情况的主要分布在少数几种疾病类型上，因此这样的情况对于本
实验相对更加有利，疾病分布对实验结果影响较小。

{
\small
\begin{longtable}{>{\centering}p{0.2\columnwidth}>{\centering}p{0.4\columnwidth}>{\centering\arraybackslash}p{0.2\columnwidth}}

    \caption{已筛选的所有肾功能衰竭疾病类型与患者数量}
    \label{diease_type_with_count}\\

    \toprule
    \textbf{ICD编码} & \textbf{疾病类型}    & \textbf{入院次数} \\ 
	\midrule  %这一条线是三线表中间的细线
	\endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
	\multicolumn{3}{r}{续表}\\      %4表示有4列
	\toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{ICD编码} & \textbf{疾病类型}    & \textbf{入院次数} \\                          
	\midrule      %这条命令表示假如跨页，续页的三线表中间的细线
	\endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
	\bottomrule    % 这一条线是三线表最底下的又黑又粗的线
	\multicolumn{3}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
	\endfoot % 以上表示除表格最后一页其他页的表尾
	\bottomrule %三线表最底下的又黑又粗的线
	\endlastfoot %最后一页的表尾

    5849           & {\color[HTML]{333333} 急性肾衰竭，未指明}              & 29276         \\
    N179           & {\color[HTML]{333333} 急性肾衰竭，未指明}              & 21214         \\
    5845           & {\color[HTML]{333333} 急性肾衰竭伴肾小管坏死}            & 3362          \\
    N170           & {\color[HTML]{333333} 急性肾衰竭伴肾小管坏死}            & 2642          \\
    N990           & {\color[HTML]{333333} 术后(急性)(慢性)肾衰竭}          & 174           \\
    N178           & {\color[HTML]{333333} 其他急性肾衰竭}                & 156           \\
    5848           & {\color[HTML]{333333} 急性肾衰竭伴肾脏其他特定病理病变}       & 122           \\
    586            & {\color[HTML]{333333} 肾功能衰竭,不明}               & 81            \\
    O904           & {\color[HTML]{333333} 产后急性肾衰竭}                & 36            \\
    N19            & {\color[HTML]{333333} 未指明的肾功能衰竭}              & 33            \\
    66932          & {\color[HTML]{333333} 分娩后急性肾衰竭，分娩时，有产后并发症}    & 30            \\
    P960           & {\color[HTML]{333333} 先天性肾衰}                  & 9             \\
    66934          & {\color[HTML]{333333} 急性肾衰竭后分娩，产后条件或并发症}      & 6             \\
    5847           & {\color[HTML]{333333} 急性肾衰竭伴肾髓质{[}乳头状{]}坏死病变} & 5             \\
    N171           & {\color[HTML]{333333} 急性肾衰竭伴急性皮质坏死}           & 4             \\
    6393           & {\color[HTML]{333333} 流产、异位妊娠和臼齿妊娠后的肾衰竭}      & 1             \\
    N172           & {\color[HTML]{333333} 急性肾衰竭伴髓质坏死}             & 1           \\ 

    \end{longtable}
}

排除没有入住ICU的患者。患者的ICU相关信息均存储在MIMIC-IV的icu模块中，因此需要将icu模块与core模块进行连
接，筛选出在icu模块中有记录的患者作为研究对象。此时采集到共有10514条数据，其中包括8249名患者。

接下来是排除住院时年龄小于18周岁的患者，纳入后续分析的数据共有10502条。

由于同一名患者可能出现多次入院或多次进入ICU的情况，实际上对于患者的结局往往决定于首次入院的相关诊断，且
多次入院可能某些基本指标的值存在相同情况。因此研究中只纳入统一病人首次入院的相关信息。此外，本文实验将
患者每次住院开始时间作为统计其死亡的起点，将患者院内死亡时间或者患者在记录时间段内未死亡作为统计的终点。
因此，本文实验中共计纳入8249条数据。

关于患者的特征选择，在参考相关研究后，本文实验从患者基础信息、出入院信息、生命体征、实验室检查、用药情
况、ICU信息、常用重症评分和透析情况8个方面进行选择。

患者基础信息：包括住院时年龄、身高、体重、性别、种族、婚姻状况等；在MIMIC-IV数据库中的年龄都经过了去敏
处理以保证患者信息隐私。因此，本文实验的年龄计算参考既往研究方案，通过入院时间和其他数据库提供的时间指
标推算而得。

出入院信息：包括住院时间、出院时间、累计住院时间、是否进入急诊、进入急诊时间、急诊结束时间、累计急诊时
间、院内死亡时间等。

ICU信息：ICU累计停留次数、ICU累计停留时间、ICU停留类型；实际上由于患者的差异在ICU停留的时间和停留ICU
的类型种类不同，因此为了直观评估患者的ICU停留情况，计算出每次ICU停留的累计时间、每名患者的累计停留次
数以及ICU停留类型。在数据中共包含了9种ICU类型，分别为：创伤外科重症监护室、冠心病监护室、内科/外科重
症监护室、神经降压监护室、神经外科加护病房、神经中叶监护室、外科重症监护室、心脏血管重症监护室、医疗重
症监护室。

进入ICU后24小时内生命体征：呼吸率、平均动脉压、收缩压、舒张压、温度、心率；生命体征指标选择的是患
者进入ICU后24小时内的最大值、最小值、平均值指标。

进入ICU后24小时内实验室检查：包括动脉血气分析相关指标、肝肾功能指标、血常规指标、血电解质指标、总
排尿量。共计36项，具体指标情况详见表\ref{icu_24_lab_indic}，指标采用最大值、最小值衡量。

进入ICU后24小时内用药情况：包括是否服用苯肾上腺素、是否服用抗生素、是否服用后叶加压素、是否服用后
叶加压素、是否服用神经肌肉阻断剂、是否服用肾上腺素。

进入ICU后24小时内常用重症评分：Logistic器官功能障碍评分、急性生理评分III 、简化急性生理评分II 、
牛津急性疾病严重程度评分、全身炎症反应综合征标准、序贯器官衰竭评估。

透析情况与进入ICU后24小时内尿常规：目前存在的透析、透析类型等。

合并症：Charlson发病率指数。患者可能存在多类合并症，但如果将合并症都采取到会出现变量冗余切过于稀疏的
况，因此采用Charlson发病率指数对合并症进行综合衡量。

通过采集共计纳入后续分析的指标202个，其中包括目标变量生存时间和终点事件。
{
\small
% \begin{longtable}{ccc}
\begin{longtable}{>{\centering}p{0.3\columnwidth}>{\centering}p{0.25\columnwidth}>{\centering\arraybackslash}p{0.25\columnwidth}}

    \caption{重症监护室24小时内实验室检查指标}
    \label{icu_24_lab_indic}\\

    \toprule
    \textbf{特征类型} & \textbf{特征名} & \textbf{取值方式} \\ 
	\midrule  %这一条线是三线表中间的细线
	\endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
	\multicolumn{3}{r}{续表}\\      %4表示有4列
	\toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{特征类型} & \textbf{特征名} & \textbf{取值方式} \\                       
	\midrule      %这条命令表示假如跨页，续页的三线表中间的细线
	\endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
	\bottomrule    % 这一条线是三线表最底下的又黑又粗的线
	\multicolumn{3}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
	\endfoot % 以上表示除表格最后一页其他页的表尾
	\bottomrule %三线表最底下的又黑又粗的线
	\endlastfoot %最后一页的表尾

    实验室检查-血电解质    & 钙离子          & 最小值/最大值       \\
    实验室检查-血电解质    & 氯离子          & 最小值/最大值       \\
    实验室检查-血电解质    & 血纳值          & 最小值/最大值       \\
    实验室检查-血电解质    & 血钾值          & 最小值/最大值       \\
    实验室检查-血常规     & 血细胞比容        & 最小值/最大值       \\
    实验室检查-血常规     & 血红蛋白         & 最小值/最大值       \\
    实验室检查-血常规     & 血小板          & 最小值/最大值       \\
    实验室检查-血常规     & 白细胞          & 最小值/最大值       \\
    实验室检查-肝肾功能    & 血清白蛋白        & 最小值/最大值       \\
    实验室检查-肝肾功能    & 球蛋白          & 最小值/最大值       \\
    实验室检查-肝肾功能    & 血清总蛋白        & 最小值/最大值       \\
    实验室检查-肝肾功能    & 血尿素氮值        & 最小值/最大值       \\
    实验室检查-肝肾功能    & 血肌酐值         & 最小值/最大值       \\
    实验室检查-肝肾功能    & 血糖值          & 最小值/最大值       \\
    实验室检查-肝肾功能    & 丙氨酸氨基转移酶     & 最小值/最大值       \\
    实验室检查-肝肾功能    & 碱性磷酸酶        & 最小值/最大值       \\
    实验室检查-肝肾功能    & 天冬氨酸转氨酶      & 最小值/最大值       \\
    实验室检查-肝肾功能    & 淀粉酶          & 最小值/最大值       \\
    实验室检查-肝肾功能    & 总胆红素         & 最小值/最大值       \\
    实验室检查-肝肾功能    & 直接胆红素        & 最小值/最大值       \\
    实验室检查-肝肾功能    & 间接胆红素        & 最小值/最大值       \\
    实验室检查-肝肾功能    & 肌酸磷酸激酶       & 最小值/最大值       \\
    实验室检查-肝肾功能    & 肌酸激酶同工酶      & 最小值/最大值       \\
    实验室检查-肝肾功能    & γ谷氨酰转移酶      & 最小值/最大值       \\
    实验室检查-肝肾功能    & 乳酸脱氢酶        & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 阴离子间隙        & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 碳酸氢盐         & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 乳酸值          & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 酸碱度          & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 氧饱和度         & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 氧分压值         & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 二氧化碳分压       & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 肺泡-动脉氧分压差    & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 氧合指数         & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 剩余碱          & 最小值/最大值       \\
    实验室检查-动脉血气分析  & 二氧化碳生产       & 最小值/最大值       \\
    \end{longtable}
}

\section{数据清洗}

通过前文介绍收集到的数据共有8249条数据，202个变量。在统计分析和建模中使用到的数据通常是经过了处理之后的
干净数据，本文从MIMIC-IV数据库中采集并筛选到的数据需要进一步整理为可用于建模的感觉数据，关于数据清洗
的核心代码详见附录\ref{pythoncodes1}。数据处理的主要流程如图\ref{data_clear_flew}所示：

\begin{figure}[htb]
    \begin{center}
    \includegraphics[width=0.9\columnwidth]{bodyfiguretables/data_clear_flew}
    \end{center}
    \caption{数据处理流程框架图}
    \label{data_clear_flew}
\end{figure}

缺失值处理：收集到的数据中大部分变量均含有缺失值，因此有必要对缺失值进行专门的处理。目前对缺失值较为常见
的处理方式有三种：删除记录、数据填补、空值处理，其中数据填补又分为：人工填补、均数填补、中位数或众数填
补、多重填补、插值填补等。本文实验对于不同情况的变量的缺失值样本研究采用不同的处理方式，详见
表\ref{missvalue_deal_type}。在变量重要性中，根据既往临床研究结果，本文实验将"实验室检查" , 
"生命体征", "ICU信息", "尿常规", "透析"等考虑为重要变量，其他变量考虑为次重要变量。需要注意的是，此处的变量重要程
度仅作为缺失值填补使用，对后续统计模型过程不
产生影响。另外对于简单填补方法研究中会根据数据的分布情况不同而填补不同的值，若特征分布服从均匀分布则用均值
填充，若数据分布存在倾斜分布则用中位数填充。变量分箱是根据连续变量的具体数值大小进行等间距分箱处理，所有
进行分箱处理的变量都会处理为5个类别：“Low”, “Lower”, “Medium”, “Higher”, “High”，同时缺失值被赋值
为“Missing”并单独作为一个类别。对于缺失替换实验中会将缺失值单独赋值为“Missing”并作为变量的一个类别处理，
而类别合并方法则是将缺失值和频数小于10的类别进行合并。经过处理后剩余8249条观测，129个特征变量。

{
\small
\begin{longtable}{>{\centering}p{0.2\columnwidth}>{\centering}p{0.2\columnwidth}>{\centering}p{0.2\columnwidth}>{\centering\arraybackslash}p{0.2\columnwidth}}

    \caption{缺失值处理方式}
    \label{missvalue_deal_type}\\
    \toprule
    \textbf{变量类型} & \textbf{重要性} & \textbf{缺失率} & \textbf{处理方法} \\ 
	\midrule  %这一条线是三线表中间的细线
	\endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
	\multicolumn{4}{r}{续表}\\      %4表示有4列
	\toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{变量类型} & \textbf{重要性} & \textbf{缺失率} & \textbf{处理方法} \\ 
	\midrule      %这条命令表示假如跨页，续页的三线表中间的细线
	\endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
	\bottomrule    % 这一条线是三线表最底下的又黑又粗的线
	\multicolumn{4}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
	\endfoot % 以上表示除表格最后一页其他页的表尾
	\bottomrule %三线表最底下的又黑又粗的线
	\endlastfoot %最后一页的表尾

    连续变量          & 高            & (0,0.2)      & 插值填补          \\
    连续变量          & 低            & (0,0.2)      & 简单填补          \\
    连续变量          & 高            & {[}0.2,0.5)  & 变量分箱          \\
    连续变量          & 低            & {[}0.2,0.5)  & 简单填补          \\
    连续变量          & 高            & {[}0.5,1{]}  & 变量分箱          \\
    连续变量          & 低            & {[}0.5,1{]}  & 删除变量          \\
    离散变量          & 高            & (0,0.5)      & 缺失替换          \\
    离散变量          & 低            & (0,0.5)      & 类别合并          \\
    离散变量          & 高            & {[}0.5,1{]}  & 缺失替换          \\
    离散变量          & 低            & {[}0.5,1{]}  & 删除变量          \\

    \end{longtable}

}


异常值处理：对于异常值的处理一般分为异常值的鉴别和异常值的处理两步。异常值查找目前常用的方式是箱线图、描
述分析、3$\sigma$准则、绝对离差中位数等。本实验在处理过程中先通过观察各变量的箱线图，确定变量的离群点情况，
再通过3$\sigma$准则进一步精确识别各变量的异常值。对异常值的处理本文仍然根据变量不同采用了不同的异常值处理
方式，异常点的数量较多和变量重要性较低将数据剔除，若对数据进行Log-Scale变换后消除异常值则采用变量变换，
其他情况用平均值和中位数替换异常值。经过处理后剩余8249条观测，129个特征变量。

编码处理：为了使数据适用于模型，对变量进行编码处理。若数据为有序的分类变量则采用数值编码；若数据为无序的
分类变量则采用One-Hot编码，当然某些分类变量实际本身就是0-1分类变量不再进行编码。处理后剩余10514条观测，
164个特征变量。

归一化处理：归一化就是将数据映射到某一固定区间，一般为(0,1)或(-1,1)。主要是为了避免了单位量纲对模型
实验的影响，因此本研究对所有连续变量采用了Z-Score归一化处理，使得各维度的变量统一量级。经过处理后剩余
8249条观测，163个特征变量。

特征筛选：由于部分变量存在过度稀疏的情况，如果将所有特征变量纳入模型分析中，可能会引入大量的贡献度极低
的特征变量或具有强共线性的指标，造成模型结果的不稳定性。
考虑到神经网络往往与内部网络结构之间具有复杂的嵌套关系，数据规模也对模型的计算速度影响很大，如
不经过筛选的把所有特征变量都引入模型中，则可能会造成模拟的训练持续时间过长、建模结果无法收敛等问题。
所以本实验在建模前将采用Log-Rank检
验过滤和单因素分析过滤的综合结果对所有特征变量进行初步筛选。将每个患者按照结局事件分为生存组和死亡组，
进行单因素的Log-Rank检验，如果变量为连续变量则根据该变量的中位数值将其划分为“高”、“低”两个亚组进行检验，
根据检验结果筛选出Log-Rank检验的P值小于0.001的变量。将筛选出的变量进行单因素的CPH回归，进一步筛选
出其中CPH模型结果的一致性指数大于0.55的所有变量。共68个特征变量，具体选择的指标如表\ref{val_select_res}：

{
\small
\begin{longtable}{>{\centering}p{0.4\columnwidth}>{\centering\arraybackslash}p{0.4\columnwidth}}

    \caption{变量初筛结果}
    \label{val_select_res} \\
    \toprule
    \textbf{变量名} & \textbf{变量名} \\ 
	\midrule  %这一条线是三线表中间的细线
	\endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
	\multicolumn{2}{r}{续表}\\      %4表示有4列
	\toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{变量名} & \textbf{变量名} \\ 
	\midrule      %这条命令表示假如跨页，续页的三线表中间的细线
	\endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
	\bottomrule    % 这一条线是三线表最底下的又黑又粗的线
	\multicolumn{2}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
	\endfoot % 以上表示除表格最后一页其他页的表尾
	\bottomrule %三线表最底下的又黑又粗的线
	\endlastfoot %最后一页的表尾

    简化急性生理评分II       & 舒张压-平均值       \\
    急性生理评分III        & 二氧化碳分压-最大值    \\
    牛津急性疾病严重程度评分     & 收缩压-最大值       \\
    Logistic器官功能障碍评分 & 天冬氨酸转氨酶-最大值   \\
    总排尿量             & 血肌酐值-最大值      \\
    序贯器官衰竭评估         & 氧合指数-最小值      \\
    收缩压-最小值          & 天冬氨酸转氨酶-最小值   \\
    阴离子间隙-最大值        & 氧合指数-最大值      \\
    去甲肾上腺素-是/否       & 丙氨酸氨基转移酶-最大值  \\
    收缩压-平均值          & 丙氨酸氨基转移酶-最小值  \\
    阴离子间隙-最小值        & 血肌酐值-最小值      \\
    平均动脉压-最小值        & 血钾值-最大值       \\
    碳酸氢盐-最小值         & 肌酸磷酸激酶-最大值    \\
    乳酸值-最大值          & 肌酸磷酸激酶-最小值    \\
    呼吸率-平均值          & 白细胞-最小值       \\
    乳酸值-最小值          & 心率-最大值        \\
    碳酸氢盐-最大值         & Charlson发病率指数 \\
    后叶加压素-是/否        & 温度-最大值        \\
    全身炎症反应综合征标准      & 体重            \\
    舒张压-最小值          & 苯肾上腺素-是/否     \\
    温度-最小值           & 氧分压值-最大值      \\
    平均动脉压-平均值        & 钙离子-最小值       \\
    年龄               & 心率-平均值        \\
    温度-平均值           & 氧分压值-最小值      \\
    血尿素氮值-最小值        & 呼吸率-最小值       \\
    血尿素氮值-最大值        & 乳酸脱氢酶-最小值     \\
    白细胞-最大值          & 乳酸脱氢酶-最大值     \\
    碱性磷酸酶-最大值        & 氧饱和度-最大值      \\
    呼吸率-最大值          & 肺泡-动脉氧分压差-最大值 \\
    总胆红素-最大值         & 肺泡-动脉氧分压差-最小值 \\
    肌酸激酶同工酶-最大值      & 二氧化碳分压-最小值    \\
    碱性磷酸酶-最小值        & 血糖值-最大值       \\
    肌酸激酶同工酶-最小值      & 二氧化碳生产-最大值    \\
    总胆红素-最小值         & 氧饱和度-最小值      \\ 

    \end{longtable}

}

数据集划分处理：将上述处理之后数据按照6:2:2的比例划分为训练集(4949)、验证集(1650)、测试集(1650)，
各数据子集据包含所有的68个特征变量。



%---------------------------------------
\chapter{重症肾衰竭患者的生存分析}
%---------------------------------------
本章主要介绍基于第2章所介绍的6种生存分析模型进行实证研究，并对这6种生存分析模型结果应用多种评价指标进行多维评价对比，
此外，本章最后还展示了重症肾功能衰竭疾病的重要危险因素和重要保护因素。


%---------------------------------------
\section{重症肾衰竭患者的描述性统计分析}
%---------------------------------------
将所有训练集患者按照是否发生院内死亡的结局分为生存组和死亡组，首先进行进行了描述性统计分析来总结数据集。
患者的基础特征结果见表\ref{all_var_basic_desc}所示。


% Please add the following required packages to your document preamble:

% \usepackage{booktabs}
{
\small
\begin{longtable}{c>{\centering}p{0.3\columnwidth}>{\centering\arraybackslash}p{0.3\columnwidth}}

    \caption{各特征变量基本信息统计表-M图}
    \label{all_var_basic_desc}\\
    

    \toprule
    \textbf{变量} & \textbf{生存组} & \textbf{死亡组} \\ 
    \midrule  %这一条线是三线表中间的细线
    \endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
    \multicolumn{3}{r}{续表}\\      %4表示有4列
    \toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{变量} & \textbf{生存组} & \textbf{死亡组} \\ 
    \midrule      %这条命令表示假如跨页，续页的三线表中间的细线
    \endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
    \bottomrule    % 这一条线是三线表最底下的又黑又粗的线
    \multicolumn{3}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
    \endfoot % 以上表示除表格最后一页其他页的表尾
    \bottomrule %三线表最底下的又黑又粗的线
    \endlastfoot %最后一页的表尾
  
    去甲肾上腺素-是/否       &                &                  \\
    是                & 687(15.88\%)   & 367(58.91\%)     \\
    否                & 3639(84.12\%)  & 256(41.09\%)     \\
    后叶加压素-是/否        &                &                  \\
    否                & 4165(96.28\%)  & 403(64.69\%)     \\
    是                & 161(3.72\%)    & 220(35.31\%)     \\
    苯肾上腺素-是/否        &                &                  \\
    否                & 3706(85.67\%)  & 393(63.08\%)     \\
    是                & 620(14.33\%)   & 230(36.92\%)     \\
    乳酸值-最大值          &                &                  \\
    低                & 2055(47.5\%)   & 330(52.97\%)     \\
    缺失               & 2076(47.99\%)  & 143(22.95\%)     \\
    较低               & 158(3.65\%)    & 91(14.61\%)      \\
    中                & 31(0.72\%)     & 40(6.42\%)       \\
    较高               & 6(0.14\%)      & 12(1.93\%)       \\
    高                & 0(0.00\%)       & 7(1.12\%)        \\
    乳酸值-最小值          &                &                  \\
    低                & 2200(50.86\%)  & 391(62.76\%)     \\
    缺失               & 2076(47.99\%)  & 143(22.95\%)     \\
    较低               & 47(1.09\%)     & 65(10.43\%)      \\
    中                & 3(0.07\%)      & 17(2.73\%)       \\
    较高               & 0(0.00\%)       & 5(0.80\%)         \\
    高                & 0(0.00\%)       & 2(0.32\%)        \\
    碱性磷酸酶-最大值        &                &                  \\
    低                & 2530(58.48\%)  & 472(75.76\%)     \\
    缺失               & 1743(40.29\%)  & 129(20.71\%)     \\
    较低               & 45(1.04\%)     & 16(2.57\%)       \\
    中                & 6(0.14\%)      & 3(0.48\%)        \\
    较高               & 1(0.02\%)      & 2(0.32\%)        \\
    高                & 1(0.02\%)      & 1(0.16\%)        \\
    总胆红素-最大值         &                &                  \\
    低                & 2567(59.34\%)  & 444(71.27\%)     \\
    缺失               & 1704(39.39\%)  & 134(21.51\%)     \\
    较低               & 39(0.90\%)      & 29(4.65\%)       \\
    中                & 11(0.25\%)     & 12(1.93\%)       \\
    较高               & 4(0.09\%)      & 4(0.64\%)        \\
    高                & 1(0.02\%)      & 0(0.00\%)        \\
    \multicolumn{2}{l}{肌酸激酶同工酶-最大值}   &                  \\
    缺失               & 2813(65.03\%)  & 325(52.17\%)     \\
    低                & 1453(33.59\%)  & 267(42.86\%)     \\
    较低               & 31(0.72\%)     & 16(2.57\%)       \\
    中                & 15(0.35\%)     & 8(1.28\%)        \\
    较高               & 9(0.21\%)      & 5(0.80\%)         \\
    高                & 5(0.12\%)      & 2(0.32\%)        \\
    碱性磷酸酶-最小值        &                &                  \\
    低                & 2538(58.67\%)  & 477(76.57\%)     \\
    缺失               & 1743(40.29\%)  & 129(20.71\%)     \\
    较低               & 42(0.97\%)     & 14(2.25\%)       \\
    中                & 1(0.02\%)      & 1(0.16\%)        \\
    高                & 0(0.00\%)       & 1(0.16\%)        \\
    较高               & 2(0.05\%)      & 1(0.16\%)        \\
    \multicolumn{2}{l}{肌酸激酶同工酶-最小值}   &                  \\
    缺失               & 2813(65.03\%)  & 325(52.17\%)     \\
    低                & 1480(34.21\%)  & 274(43.98\%)     \\
    较低               & 18(0.42\%)     & 16(2.57\%)       \\
    中                & 9(0.21\%)      & 5(0.80\%)         \\
    高                & 3(0.07\%)      & 2(0.32\%)        \\
    较高               & 3(0.07\%)      & 1(0.16\%)        \\
    总胆红素-最小值         &                &                  \\
    低                & 2577(59.57\%)  & 450(72.23\%)     \\
    缺失               & 1704(39.39\%)  & 134(21.51\%)     \\
    较低               & 31(0.72\%)     & 25(4.01\%)       \\
    中                & 9(0.21\%)      & 10(1.61\%)       \\
    较高               & 3(0.07\%)      & 4(0.64\%)        \\
    高                & 2(0.05\%)      & 0(0.00\%)        \\
    \multicolumn{2}{l}{二氧化碳分压-最大值}    &                  \\
    较低               & 1201(27.76\%)  & 247(39.65\%)     \\
    低                & 1328(30.70\%)   & 247(39.65\%)     \\
    缺失               & 1729(39.97\%)  & 103(16.53\%)     \\
    中                & 61(1.41\%)     & 20(3.21\%)       \\
    较高               & 7(0.16\%)      & 4(0.64\%)        \\
    高                & 0(0.00\%)       & 2(0.32\%)        \\
    \multicolumn{2}{l}{天冬氨酸转氨酶-最大值}   &                  \\
    低                & 2578(59.59\%)  & 483(77.53\%)     \\
    缺失               & 1716(39.67\%)  & 128(20.55\%)     \\
    较低               & 20(0.46\%)     & 7(1.12\%)        \\
    中                & 8(0.18\%)      & 5(0.80\%)         \\
    较高               & 2(0.05\%)      & 0(0.00\%)        \\
    高                & 2(0.05\%)      & 0(0.00\%)        \\
    氧合指数-最小值         &                &                  \\
    低                & 1315(30.4\%)   & 361(57.95\%)     \\
    缺失               & 2993(69.19\%)  & 259(41.57\%)     \\
    较低               & 17(0.39\%)     & 3(0.48\%)        \\
    高                & 1(0.02\%)      & 0(0.00\%)        \\
    \multicolumn{2}{l}{天冬氨酸转氨酶-最小值}   &                  \\
    低                & 2587(59.8\%)   & 487(78.17\%)     \\
    缺失               & 1716(39.67\%)  & 128(20.55\%)     \\
    较低               & 17(0.39\%)     & 4(0.64\%)        \\
    中                & 3(0.07\%)      & 3(0.48\%)        \\
    高                & 2(0.05\%)      & 1(0.16\%)        \\
    较高               & 1(0.02\%)      & 0(0.00\%)        \\
    氧合指数-最大值         &                &                  \\
    低                & 1193(27.58\%)  & 332(53.29\%)     \\
    缺失               & 2993(69.19\%)  & 259(41.57\%)     \\
    较低               & 129(2.98\%)    & 29(4.65\%)       \\
    中                & 10(0.23\%)     & 2(0.32\%)        \\
    较高               & 0(0.00\%)       & 1(0.16\%)        \\
    高                & 1(0.02\%)      & 0(0.00\%)        \\
    \multicolumn{2}{l}{丙氨酸氨基转移酶-最大值}  &                  \\
    低                & 2564(59.27\%)  & 484(77.69\%)     \\
    缺失               & 1727(39.92\%)  & 132(21.19\%)     \\
    较低               & 21(0.49\%)     & 5(0.80\%)         \\
    中                & 11(0.25\%)     & 2(0.32\%)        \\
    较高               & 2(0.05\%)      & 0(0.00\%)        \\
    高                & 1(0.02\%)      & 0(0.00\%)        \\
    \multicolumn{2}{l}{丙氨酸氨基转移酶-最小值}  &                  \\
    低                & 2575(59.52\%)  & 488(78.33\%)     \\
    缺失               & 1727(39.92\%)  & 132(21.19\%)     \\
    较低               & 17(0.39\%)     & 3(0.48\%)        \\
    中                & 7(0.16\%)      & 0(0.00\%)        \\
    \multicolumn{2}{l}{肌酸磷酸激酶-最大值}    &                  \\
    缺失               & 2604(60.19\%)  & 311(49.92\%)     \\
    低                & 1710(39.53\%)  & 308(49.44\%)     \\
    较高               & 2(0.05\%)      & 2(0.32\%)        \\
    中                & 2(0.05\%)      & 1(0.16\%)        \\
    较低               & 7(0.16\%)      & 1(0.16\%)        \\
    高                & 1(0.02\%)      & 0(0.00\%)        \\
    \multicolumn{2}{l}{肌酸磷酸激酶-最小值}    &                  \\
    缺失               & 2604(60.19\%)  & 311(49.92\%)     \\
    低                & 1713(39.60\%)   & 310(49.76\%)     \\
    较低               & 6(0.14\%)      & 2(0.32\%)        \\
    中                & 2(0.05\%)      & 0(0.00\%)        \\
    较高               & 1(0.02\%)      & 0(0.00\%)        \\
    氧分压值-最大值         &                &                  \\
    低                & 1529(35.34\%)  & 286(45.91\%)     \\
    较低               & 463(10.70\%)    & 134(21.51\%)     \\
    缺失               & 1729(39.97\%)  & 103(16.53\%)     \\
    中                & 362(8.37\%)    & 69(11.08\%)      \\
    较高               & 226(5.22\%)    & 31(4.98\%)       \\
    高                & 17(0.39\%)     & 0(0.00\%)        \\
    氧分压值-最小值         &                &                  \\
    低                & 2224(51.41\%)  & 471(75.60\%)      \\
    缺失               & 1729(39.97\%)  & 103(16.53\%)     \\
    较低               & 334(7.72\%)    & 44(7.06\%)       \\
    中                & 19(0.44\%)     & 3(0.48\%)        \\
    较高               & 14(0.32\%)     & 2(0.32\%)        \\
    高                & 6(0.14\%)      & 0(0.00\%)        \\
    乳酸脱氢酶-最小值        &                &                  \\
    低                & 1592(36.80\%)   & 317(50.88\%)     \\
    缺失               & 2721(62.9\%)   & 293(47.03\%)     \\
    较低               & 11(0.25\%)     & 9(1.44\%)        \\
    较高               & 0(0.00\%)       & 4(0.64\%)        \\
    高                & 1(0.02\%)      & 0(0.00\%)        \\
    中                & 1(0.02\%)      & 0(0.00\%)        \\
    乳酸脱氢酶-最大值        &                &                  \\
    低                & 1598(36.94\%)  & 318(51.04\%)     \\
    缺失               & 2721(62.90\%)   & 293(47.03\%)     \\
    较低               & 6(0.14\%)      & 9(1.44\%)        \\
    中                & 0(0.00\%)       & 3(0.48\%)        \\
    较高               & 1(0.02\%)      & 0(0.00\%)        \\
    氧饱和度-最大值         &                &                  \\
    缺失               & 3133(72.42\%)  & 341(54.74\%)     \\
    高                & 943(21.80\%)    & 226(36.28\%)     \\
    较高               & 146(3.37\%)    & 27(4.33\%)       \\
    中                & 69(1.60\%)      & 20(3.21\%)       \\
    较低               & 25(0.58\%)     & 5(0.80\%)         \\
    低                & 10(0.23\%)     & 4(0.64\%)        \\
    \multicolumn{2}{l}{肺泡-动脉氧分压差-最大值} &                  \\
    缺失               & 4108(94.96\%)  & 506(81.22\%)     \\
    高                & 75(1.73\%)     & 51(8.19\%)       \\
    较高               & 73(1.69\%)     & 36(5.78\%)       \\
    中                & 34(0.79\%)     & 20(3.21\%)       \\
    较低               & 25(0.58\%)     & 10(1.61\%)       \\
    低                & 11(0.25\%)     & 0(0.00\%)        \\
    \multicolumn{2}{l}{肺泡-动脉氧分压差-最小值} &                  \\
    缺失               & 4108(94.96\%)  & 506(81.22\%)     \\
    高                & 61(1.41\%)     & 41(6.58\%)       \\
    较高               & 78(1.80\%)      & 36(5.78\%)       \\
    中                & 40(0.92\%)     & 26(4.17\%)       \\
    较低               & 28(0.65\%)     & 12(1.93\%)       \\
    低                & 11(0.25\%)     & 2(0.32\%)        \\
    \multicolumn{2}{l}{二氧化碳分压-最小值}    &                  \\
    较低               & 1946(44.98\%)  & 358(57.46\%)     \\
    低                & 381(8.81\%)    & 120(19.26\%)     \\
    缺失               & 1729(39.97\%)  & 103(16.53\%)     \\
    中                & 249(5.76\%)    & 35(5.62\%)       \\
    较高               & 20(0.46\%)     & 6(0.96\%)        \\
    高                & 1(0.02\%)      & 1(0.16\%)        \\
    \multicolumn{2}{l}{二氧化碳生产-最大值}    &                  \\
    较低               & 2224(51.41\%)  & 406(65.17\%)     \\
    缺失               & 1729(39.97\%)  & 103(16.53\%)     \\
    低                & 243(5.62\%)    & 84(13.48\%)      \\
    中                & 122(2.82\%)    & 29(4.65\%)       \\
    较高               & 7(0.16\%)      & 1(0.16\%)        \\
    高                & 1(0.02\%)      & 0(0.00\%)        \\
    氧饱和度-最小值         &                &                  \\
    缺失               & 3133(72.42\%)  & 341(54.74\%)     \\
    高                & 828(19.14\%)   & 161(25.84\%)     \\
    较高               & 202(4.67\%)    & 53(8.51\%)       \\
    中                & 106(2.45\%)    & 47(7.54\%)       \\
    较低               & 42(0.97\%)     & 13(2.09\%)       \\
    低                & 15(0.35\%)     & 8(1.28\%)        \\
                     &                &                  \\
    简化急性生理评分II       & 54.91(15.85)   & 37.36(12.57)     \\
    急性生理评分III        & 85.57(29.00)   & 50.91(19.04)     \\
    牛津急性疾病严重程度评分     & 41.70(9.89)    & 30.67(8.53)      \\
    Logistic器官功能障碍评分 & 9.34(3.63)     & 5.12(2.72)       \\
    总排尿量             & 930.45(972.75) & 1767.99(1310.98) \\
    序贯器官衰竭评估         & 9.91(4.43)     & 5.28(3.27)       \\
    收缩压-最小值          & 81.59(19.27)   & 93.62(17.51)     \\
    阴离子间隙-最大值        & 20.67(6.59)    & 18.01(5.58)      \\
    收缩压-平均值          & 109.13(17.24)  & 119.14(17.32)    \\
    阴离子间隙-最小值        & 16.03(4.88)    & 13.79(3.47)      \\
    平均动脉压-最小值        & 50.72(15.20)   & 58.85(13.94)     \\
    碳酸氢盐-最小值         & 18.37(6.04)    & 20.62(5.37)      \\
    呼吸率-平均值          & 21.48(4.55)    & 19.26(3.71)      \\
    碳酸氢盐-最大值         & 22.03(5.60)    & 23.84(4.63)      \\
    全身炎症反应综合征标准      & 2.97(0.86)     & 2.46(0.95)       \\
    舒张压-最小值          & 40.75(12.21)   & 46.15(12.22)     \\
    温度-最小值           & 35.94(0.95)    & 36.29(0.61)      \\
    平均动脉压-平均值        & 72.33(11.02)   & 77.45(11.86)     \\
    年龄               & 72.66(14.41)   & 67.63(16.24)     \\
    温度-平均值           & 36.57(0.77)    & 36.78(0.48)      \\
    血尿素氮值-最小值        & 46.15(29.78)   & 35.41(25.16)     \\
    血尿素氮值-最大值        & 52.80(31.69)   & 42.72(29.45)     \\
    白细胞-最大值          & 17.38(15.71)   & 13.71(11.77)     \\
    呼吸率-最大值          & 30.30(6.86)    & 27.71(6.21)      \\
    舒张压-平均值          & 58.79(11.19)   & 62.83(11.92)     \\
    收缩压-最大值          & 141.42(26.73)  & 147.44(23.14)    \\
    血肌酐值-最大值         & 2.53(1.70)     & 2.36(2.18)       \\
    血肌酐值-最小值         & 2.10(1.47)     & 1.87(1.62)       \\
    血钾值-最大值          & 4.92(0.99)     & 4.77(0.97)       \\
    白细胞-最小值          & 12.68(11.44)   & 10.15(6.41)      \\
    心率-最大值           & 110.10(24.49)  & 101.18(19.89)    \\
    Charlson发病率指数    & 7.65(2.86)     & 6.32(2.93)       \\
    温度-最大值           & 37.19(0.96)    & 37.27(0.66)      \\
    体重               & 81.68(23.09)   & 85.20(25.05)     \\
    钙离子-最小值          & 7.86(1.04)     & 8.12(0.89)       \\
    心率-平均值           & 90.70(18.73)   & 84.36(15.61)     \\
    呼吸率-最小值          & 13.49(4.51)    & 12.56(3.51)      \\
    血糖值-最大值          & 195.65(115.76) & 191.46(146.07)   \\ 
    

    \end{longtable}
}

其中连续变量用平均值和标准差描述，分类变量用频数和占比描述。其中患者生存
组平均体重为81.68(23.09)kg，死亡组平均体重85.20(25.05)kg，生存组平均年龄在72.66(14.41)岁左右，死亡组平均年龄
为67.63(16.24)岁，生存组Charlson发病率指数为7.65(2.86)，而死亡组Charlson发病率指数为6.32(2.93)，对
于总排尿量生存组为930.45(972.75)毫升，死亡组为1767.99(1310.98)毫升。此外，关于乳酸值24小时内最大值/最
小值、碱性磷酸酶24小时内最大值、碱性磷酸酶24小时内最小值、总胆红素24小时内最小值、二氧化碳分压24小时内
最大值、天冬氨酸转氨酶24小时内最大值、氧合指数24小时内最小值、天冬氨酸转氨酶24小时内最小值、二氧化碳
生产24小时内最大值、二氧化碳分压24小时内最小值、乳酸脱氢酶24小时内最大值等变量几乎所有亚组的人群比例中，
死亡组的主要人群都集中在较低和低的亚组中，且所占比例大都远高于生存组。而对于氧饱和度24小时内最小值、肺
泡-动脉氧分压差24小时内最小值、肺泡-动脉氧分压差24小时内最大值、氧饱和度24小时内最大值、肌酸磷酸激酶24小
时内最小值等变量中，生存组的主要人群都集中在较低和低的亚组中，且所占比例大都远高于死亡组。

%---------------------------------------
\section{重症肾衰竭患者的整体生存分析}
%---------------------------------------

首先利用Kaplan-Meier生存估计方法从生存数据中估计生存函数。使用Kaplan-Meier估计可以估计患者的死亡率，
其估计出的曲线是一个阶跃函数，阶跃发生在一名或多名患者死亡的时间点，详见图\ref{plot_total_survival_time_fuction_km}。图中蓝色实线为生存曲线，
浅蓝色带代表了生存函数的95\%置信区间。从图中可以看出，随着时间增加，存活率$S(t)$越来越小，当然这是一定的。
大多数患者在前40天内死亡，如前40天内估计的生存函数的陡峭斜率所示。此外，图中红色虚线标注了$S(t)=0.5$的
位置，即患者的中位生存时间在60-70天之间。

\begin{figure}[htb]
    \begin{center}
    \includegraphics{bodyfiguretables/plot_total_survival_time_fuction_km}
    \end{center}
    \caption{整体生存函数估计曲线}
    \label{plot_total_survival_time_fuction_km}
\end{figure}

此外，绘制了发生院内死亡和未发生院内死亡的生存时间的直方图，见图\ref{plot_total_survival_time_hist}。可以看出发生院内死亡的患者未发生院内死亡的后
续生存时间远远长于发生院内死亡的患者，且未发生院内生存时间的最高生存时间达到1400天以上，而发生院内死亡
的患者最高生存时间不超过200天。随着生存时间越高，未发生院内死亡组和发生院内死亡组的人数越少，这样的结果
也与上述的K-M曲线图吻合。

\begin{figure}[htb]
    \begin{center}
    \includegraphics{bodyfiguretables/plot_total_survival_time_hist}
    \end{center}
    \caption{是否发生院内死亡情况的生存时间直方图}
    \label{plot_total_survival_time_hist}
\end{figure}

在了解患者整体生存情况后进一步绘制了各个变量特征的K-M区间，并对所有的因素进行了Log-Rank检验，当然由于
变量本身便是通过Log-Rank检验筛选的，所以在此计算的P值结果应该都是小于0.001。在检验和绘图的过程中，若
变量为分类或等级变量则不另外处理，若变量为连续变量，则根据变量的中位数将患者分为高风险组和低风险组。
其中一组变量的结果展示如下图\ref{fig:appendix_figure1}所示，其余结果展示见附录\ref{appendix_figure}。


\begin{figure}[htb]
    \begin{center}
    \includegraphics[width=1\columnwidth]{bodyfiguretables/plot_all_variables_group_km_1}
    \end{center}
    \caption{各变量的生存曲线K-M图1}
    \label{fig:appendix_figure1}
  \end{figure}


由于当前选用的所有风险变量对生存结局的影响通过Log-Rank检验呈现显著性差异，因此通过图形
视觉化初步评估各风险变量的特点，且能够大致评估分析指标对患者生存结局预后的情况。从图中可以发现，急性生
理评分III、Logistic器官功能障碍评分、碱性磷酸酶在24小时内的最小值、肌酸激酶同工酶在24小时内的最大值等
变量都存在某亚组或多个亚组中的患者在较短时间内已经全部死亡，说明这些分组因素中的亚组对于患者生存结局的
影响具有至关重要的作用。



%---------------------------------------
\section{生存分析统计模型的训练过程}
%---------------------------------------
在真实数据的生存分析中，CPH模型由于其具有较强的解释能力所以常常被用于各种领域。不过因为其具有严
格的假设限制，在真实世界生存分析中数据常常难以符合这些假设要求，在这种情况下，传统的CPH模型不能很好地刻
画变量之间错综复杂的关系以及生存结局和时间之间的关联，对患者生存率和生存时间的预测产生偏差，对协变量风险比
的估计也会产生偏差甚至出现背离的情况。因此，本研究在验证确定了各因素与患者生存相关的影响关系后，采用
Cox-ElasticNet、DeepSurv、Cox-CC、LogisticHazard、RSF、Cox-Time共6个生存分析模型对患者死亡率进行
预测对比，通过对比不同模型的预测效果进而确定一种最优的预测模型并从各方面综合评估各个模型的实证效果。由
于Cox-ElasticNet模型实际上是CPH回归模型的一种拓展惩罚模型，其在一定程度上兼顾了CPH模型的各项特点，
同时又具有弹性网回归的优点，因此研究中采用Cox-ElasticNet模型研究而不再考虑使用CPH模型。

因为Cox-Time、Cox-CC、DeepSurv、LogisticHazard都是基于神经网络对CPH模型的拓展，所以其需要调整的参
数大多数为神经网络的参数。四种模型需要调参优化的参数也基本一致，所以就不分开一一讨论。在本实验中需要调
整的参数包括：隐藏层数目(Layers)、每层节点数(Nodes)、节点丢弃率(Dropout Rate)、批处理大小(Batchsize)
、学习率(Learning Rate)。

在本研究中建立的4种深度学习生存模型的网络结构均为标准的多层感知机，每层具有相同数量的节点，激活函数采
用 ReLU 函数，采用Adam优化算法改善训练方式来最小化损失函数，在各层之间进行批量标准化
处理，使用早停回调函数，让模型在验证集上损失不再改善时停止训练，并返回在验证集上损失表现最好的模型。

关于上述神经网络的参数设置本实验采用了5折交叉验证并结合网格搜索的方法进行设置，参数搜索范围设置祥见表\ref{supterparams_range}。

{
\small
\begin{longtable}{>{\centering}p{0.3\columnwidth}>{\centering\arraybackslash}p{0.5\columnwidth}}

    \caption{超参数搜索范围}
    \label{supterparams_range} \\

    \toprule
    \textbf{搜索参数} & \textbf{搜索范围}   \\ 
    \midrule  %这一条线是三线表中间的细线
    \endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
    \multicolumn{2}{r}{续表}\\      %4表示有4列
    \toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{搜索参数} & \textbf{搜索范围}    \\ 
    \midrule      %这条命令表示假如跨页，续页的三线表中间的细线
    \endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
    \bottomrule    % 这一条线是三线表最底下的又黑又粗的线
    \multicolumn{2}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
    \endfoot % 以上表示除表格最后一页其他页的表尾
    \bottomrule %三线表最底下的又黑又粗的线
    \endlastfoot %最后一页的表尾

    'modelname'   & {[}'coxcc', 'coxtime', 'deepsurv',   'logistichazard'{]} \\
    'batch\_size' & {[}128, 256{]}                                           \\
    'dropout'     & {[}0.3{]}                                                \\
    'nodes'       & {[}{[}16, 32{]}{]}                                       \\
    'nlayers'      & {[}1, 2, 3{]}                                            \\ 

    \end{longtable}
}

在网格搜索过程中将训练模型在验证集上的一致性指数作为评分标准，选择交叉验证结果的平均一致性指数最好的模型
参数作为最佳参数集。表\ref{grad_params_range_select}展示了各模型的最优参数组合。

{
\small
\begin{longtable}{>{\centering}p{0.1\columnwidth}>{\centering}p{0.1\columnwidth}>{\centering}p{0.1\columnwidth}>{\centering}p{0.1\columnwidth}>{\centering}p{0.1\columnwidth}>{\centering}p{0.1\columnwidth}>{\centering}p{0.1\columnwidth}>{\centering\arraybackslash}p{0.1\columnwidth}}

    \caption{不同模型参数对结果的影响}
    \label{grad_params_range_select} \\
    \toprule
    \textbf{Model} & \textbf{Batchsize} & \textbf{Dropout} & \textbf{Lr} & \textbf{NLayers} & \textbf{Nodes} & \textbf{平均C指数} & \textbf{标准差}  \\ 
    \midrule  %这一条线是三线表中间的细线
    \endfirsthead %此命令之前为表格首页表头，这条命令的意思是，假如表格跨页，上面是最上面一行内容
    \multicolumn{8}{r}{续表}\\      %4表示有4列
    \toprule      %这条命令表示假如跨页，续页的三线表最上面的又黑又粗的线
    \textbf{Model} & \textbf{Batchsize} & \textbf{Dropout} & \textbf{Lr} & \textbf{NLayers} & \textbf{Nodes} & \textbf{平均C指数} & \textbf{标准差}  \\ 
    \midrule      %这条命令表示假如跨页，续页的三线表中间的细线
    \endhead % 以上命令之间表示其他页表头，这条命令的意思是，假如表格跨页，续页最上面的内容
    \bottomrule    % 这一条线是三线表最底下的又黑又粗的线
    \multicolumn{8}{c}{(接下页)}\\  %这条命令表示跨页后的表格有4列
    \endfoot % 以上表示除表格最后一页其他页的表尾
    \bottomrule %三线表最底下的又黑又粗的线
    \endlastfoot %最后一页的表尾

    deepsurv       & 256       & 0.2     & 0.1 & 3       & {[}16, 32{]} & 0.85      & 0.03 \\
    deepsurv       & 128       & 0.2     & 0.1 & 3       & {[}16, 32{]} & 0.85      & 0.02 \\
    deepsurv       & 128       & 0.2     & 0.1 & 2       & {[}16, 32{]} & 0.85      & 0.02 \\
    coxtime        & 128       & 0.2     & 0.1 & 1       & {[}16, 32{]} & 0.85      & 0.03 \\
    coxtime        & 128       & 0.4     & 0.1 & 1       & {[}16, 32{]} & 0.85      & 0.03 \\
    coxcc          & 128       & 0.2     & 0.1 & 1       & {[}16, 32{]} & 0.85      & 0.02 \\
    coxcc          & 128       & 0.6     & 0.1 & 1       & {[}16, 32{]} & 0.85      & 0.02 \\
    coxcc          & 128       & 0.4     & 0.3 & 1       & {[}16, 32{]} & 0.84      & 0.02 \\
    coxtime        & 128       & 0.6     & 0.3 & 1       & {[}16, 32{]} & 0.84      & 0.02 \\
    logistichazard & 128       & 0.4     & 0.1 & 1       & {[}16, 32{]} & 0.83      & 0.02 \\
    logistichazard & 256       & 0.2     & 0.1 & 3       & {[}16, 32{]} & 0.83      & 0.02 \\
    logistichazard & 256       & 0.6     & 0.1 & 2       & {[}16, 32{]} & 0.83      & 0.02 \\ 
    \end{longtable}
}

对于Cox-ElasticNet模型而言，在模型训练过程中惩罚系数的设置对模型的性能表现格外重要。因此在本实验通过5折交
叉验证来寻找使得一致性指数最大时的惩罚系数$\alpha$，在实验中$\alpha$的迭代范围设置为(0.001,0.9)，具体寻
优过程如图\ref{plot_elasticcox_alpha_optim}所示。在图中的红实线即为最大的一致性指数所对应的$\alpha$值，此时所对应的一致性指数在0.7至0.8之间。

\begin{figure}[htb]
    \begin{center}
    \includegraphics{bodyfiguretables/plot_elasticcox_alpha_optim}
    \end{center}
    \caption{ElasticNet模型的训练$\alpha$寻优}
    \label{plot_elasticcox_alpha_optim}
\end{figure}

通过绘制Cox-ElasticNet模型的系数与$\alpha$的变化图，见图\ref{plot_elasticcox_coef_with_aplha}。图中黑虚线为上诉寻优到的最佳惩罚系数，其在图
中可以看到，在最右侧Cox-ElasticNet模型中只有三个特征变量最后衰减为0(红、橙、棕色线)。随着$\alpha$的减
小，越来越多的特征变得活跃并且其系数被分配了一个非零系数，知道整个特征数据集中的变量都被使用到。还可以
观察到“苯肾上腺素-是/否”、“天冬氨酸转氨酶-最小值”、“血肌酐值-最大值”、“阴离子间隙-最大值”、“碱性磷酸
酶-最小值”、“全身炎症反应综合征标准”、“后叶加压素-是/否”、“血尿素氮值-最小值”、“急性生理评分III ”、
“氧合指数-最小值”变量的变化曲线很快的将其余系数分开并且路径突出，这表明这种特征变量是对于结局事件的重要
预测因素。对于Cox-ElasticNet模型还有个重要的功能就是特征筛选，在我们设置模型的惩罚系数为黑实线位置时
，模型结果共有51个特征变量系数不为0，因此我们将这51个特征变量纳入正式的Cox-ElasticNet模型的训练中。但
只是针对Cox-ElasticNet模型的变量筛选，因为前文已经通过合适的方式进行了一次变量初筛，所以对于研究中的
其他模型不采用Cox-ElasticNet模型的筛选结果。

\begin{figure}[htb]
    \begin{center}
    \includegraphics{bodyfiguretables/plot_elasticcox_coef_with_aplha}
    \end{center}
    \caption{ElasticNet模型的系数变化图}
    \label{plot_elasticcox_coef_with_aplha}
\end{figure}

随机生成森林是一种基于树模型的学习器的集合，在随机生成森林模型的训练过程中，由于随机生存森林在运算速率
上的高耗时且对计算资源要求较高，因此在研究实验中对其参数进行默认设置。在训练集上构建了拥有100颗子树的
随机生存森林。

%---------------------------------------
\section{基于评价指标的最优模型选择}
%---------------------------------------

当训练好所有模型之后，为了评估模型的效果，首先需要获得各模型在测试集的生存函数估计结果。在这过程中，各
模型的生存估计时间均已被处理为统一尺度标准。在此次展示了其中随机抽样的10名患者的各模型生存函数预测曲
线，见图\ref{plot_predict_surv_func}。图中直观的展现了6种模型的预测差异，对于Cox-CC、Cox-Time、LogisticHazard、DeepSurv模型而
言，其对于生存函数的预测波动更加明显。而Cox-ElasticNet与RSF模型对于各患者的预测趋于同质，预测结果展
示各患者之间的差异较小。且对于生存时间上的波动也较为平稳。

\begin{figure}[htb]
    \begin{center}
    \includegraphics[width=1\textwidth]{bodyfiguretables/plot_predict_surv_func}
    \end{center}
    \caption{随机的10个样本生存函数预测}
    \label{plot_predict_surv_func}
\end{figure}

显然，仅通过抽样的样本预测结果是不能全面评估各模型的性能，因此通过计算其C指数来评价各个模型的预测
结果与实际结果的一致情况，即模型的区分度。由于C指数对非比例风险模型的应用尚不明确，所以此
处对Cox-CC、Cox-Time、DeepSurv和LogisitcHazard模型采用$C^{td}$指标，其等价于比例风险模型的C指
标。为了更清晰的观察模型间的差异，将计算结果绘制为条形图，如图\ref{plot_model_cindex_eval_bar}所示。从图中可知，模型预测的一致性指
数最高的是Cox-CC模型，其次为Cox-Time与DeepSurv模型，这三个模型的一致性指数均大于0.8。而一致性指数最
低的为RSF模型，同时LogisticHazard、Cox-ElasticNet和RSF三个模型的一致性指数均在0.7至0.8之间。

\begin{figure}[htb]
    \begin{center}
    \includegraphics[width=1\textwidth]{bodyfiguretables/plot_model_cindex_eval_bar}
    \end{center}
    \caption{各模型预测结果的一致性指数}
    \label{plot_model_cindex_eval_bar}
\end{figure}

由于生存时间为一个连续的过程，在这种情况下，依赖时间的ROC曲线用于评价模型对于不同时间点的预测效果将是
一个更好的选择，详见图\ref{plot_model_eval_time_roc}。图中展示了每个时间点的时间依赖ROC下的估计面积和所有时间点的平均值AUC。从整
个时间区间的平均AUC值的角度而言，性能最好的是RSF模型，其平均AUC均达到了0.89；
最差的为LogisticHazard模型，平均AUC值为0.83。但从生存时间节点来看，Cox-CC模型于Cox-Time模型在整个
时间区间内都保持着稳定的预测性能，且每个时间点对应的AUC值都大于0.8。DeepSurv和LogisticHazard模型在
最开始的时间点上面其AUC值偏小，然后开始上升之最佳位置，此后时间点的预测也能维持在一个较稳定的状态，但
LogisticHazard模型相对于DeepSurv模型其预测准确性和稳定性要差许多。而对于Cox-ElasticNet和RSF模型其
预测效果在最开始的时间点表现出了完美的性能，但是随着时间的延后，其预测性能快速下滑，且预测效果的波动
也越加剧烈。综合而言可以得出结论，在中短期生存预测方面Cox-ElasticNet和RSF模型最为有效，对于长期的生
存预测问题Cox-CC模型展示出了更好的性能。此外，从模型稳定性的角度来看，表现最佳的模型为Cox-CC模型。

\begin{figure}[htb]
    \begin{center}
    \includegraphics[width=1\textwidth]{bodyfiguretables/plot_model_eval_time_roc}
    \end{center}
    \caption{各模型预测结果依赖时间的ROC曲线}
    \label{plot_model_eval_time_roc}
\end{figure}

虽然上述的一致性指数与ROC-Time指标显示出了Cox-CC模型在稳定性和中长期的预测性能方面有着强烈的性能表现。
但是这两个指标并不能帮助我们决定对于重症肾功能衰竭的死亡率预测问题应该选择哪个模型。因此，我们绘制了将
时间相关的BS指数作为另一个模型选择的评价方案，因为BS指数可以评估模型的区分度和校
准度。在计算过程中，采用了同前文一致的时间区间，通过生存函数估计出每个时间点的生存概率。结果如图\ref{plot_model_eval_brier_score}所
示。可以发现Cox-ElasticNet和RSF模型在BS指数最高点出变得非常不稳定，而其分数最高点在时间小于40天的
位置。对于Cox-CC和DeepSurv模型其在BS指数最高点的时候表现相对平稳，且分数最高点位置出现在100至120天。

将使用到的所有时间点的综合IBS指数来比较各模型的校准，因为这个指标能够为我们提供一个单一的值来比较模
型，实际上这是通过在定义的时间区间上进行的数值积分得到的指标。从结果来看，尽管Cox-CC模型在区分度方面表
现更加出色，但是在校准度方面(IBS=0.34)似乎存在显著差异，得到RSF模型在校准度方面(IBS=0.36)表现最优。

\begin{figure}[htb]
    \begin{center}
    \includegraphics[width=1\textwidth]{bodyfiguretables/plot_model_eval_brier_score}
    \end{center}
    \caption{各模型预测结果依赖时间的BS及IBS}
    \label{plot_model_eval_brier_score}
\end{figure}

综上，可以得到对于本文研究的6个模型而言，在重症肾功能衰竭的死亡率预测问题上，预测的区分度最好的模型
是Cox-CC模型，其次为Cox-Time模型，在预测的精确度方面表现最好的两个是Cox-ElasticNet和RSF模型，在模型稳
定性方面表现最好的是Cox-CC模型，对于模型的校准度而言，表现最好的是RSF模型，最差的
是Cox-ElasticNet模型，且对于长期的预测精度和稳定性而言，Cox-CC模型表现最佳，对于中短期的
而言，RSF模型表现最佳。

%---------------------------------------
\section{基于Cox-ElasticNet模型的结果分析}
%---------------------------------------

为了深入探究哪些特征变量是重症肾功能衰竭疾病生存时间的关键风险因素，我们进一步的探究了变量的重要性。
对于深度生存分析模型，由于其内部网络结构的决定其难以对输入特征进行充分合理的解释。因此本实验采用了
Cox-ElasticNet模型来研究变量的重要性，Cox-ElasticNet模型的结果中变量系数实际上解释了对应的危险因
素对相对危险度的影响。若变量系数为正，则相对危险度大于1，该因素为危险因素；若变量系数为负，则相对危险
度小于1，该因素为保护因素。本实验计算得到的绝对值最大的20个变量偏回归系数直方图如图\ref{plot_elasticcox_coefs_imporant_top20}所示。

\begin{figure}[htb]
    \begin{center}
    \includegraphics[width=1\textwidth]{bodyfiguretables/plot_elasticcox_coefs_imporant_top20}
    \end{center}
    \caption{Cox-ElasticNet模型的变量重要性}
    \label{plot_elasticcox_coefs_imporant_top20}
\end{figure}

可以发现其中“牛津急性疾病严重程度评分”、“总排尿量”、“阴离子间隙-最大值”、“碳酸氢盐-最小值”、“全身炎症
反应综合征标准”、“舒张压-最小值”、“血尿素氮值-最小值”、“白细胞-最大值”、“呼吸率-最大值”、“总胆红素-最小
值”、“舒张压-平均值”为重症肾功能衰竭的危险因素。“简化急性生理评分II”、“急性生理评分III”、“Logistic器官
功能障碍评分”、“序贯器官衰竭评估”、“收缩压-平均值”、“平均动脉压-最小值”、“乳酸值-最大值”、“呼吸率-平
均值”、“乳酸值-最小值”、“后叶加压素-是/否”、“温度-最小值”、“年龄”、“温度-平均值”、“血尿素氮值-最大值”、“碱
性磷酸酶-最大值”、“肌酸激酶同工酶-最大值”、“碱性磷酸酶-最小值”、“肌酸激酶同工酶-最小值”、“二氧化碳分
压-最大值”、“收缩压-最大值”、“血肌酐值-最大值”、“氧合指数-最小值”、“天冬氨酸转氨酶-最小值”、“氧合指
数-最大值”、“丙氨酸氨基转移酶-最大值”、“血肌酐值-最小值”、“温度-最大值”、“苯肾上腺素-是/否”、“呼吸率-最小
值”、“乳酸脱氢酶-最大值”、“肺泡-动脉氧分压差-最大值”、“二氧化碳分压-最小值”、“二氧化碳生产-最大值”、“天
冬氨酸转氨酶-最大值”、“肌酸磷酸激酶-最小值”、“白细胞-最小值”、“心率-最大值”、“心率-平均值”、“氧分压值-最
小值”、“氧饱和度-最小值”为重症肾功能衰竭疾病的保护因素。而其中保护因素影响最强的两个变量为氧合指数-最
小值与急性生理评分III，而危险因素影响最强的两个变量为血尿素氮值-最小值和全身炎症反应综合征标准。

对应识别出的重要保护因素和危险因素以指导患者预后疾病管理，提高患者生命质量，对于肾功能衰竭这类疾病有着
重要的意义。

%---------------------------------------
\chapter{总结及展望}
%---------------------------------------
本章节是对本文所研究内容的回顾与总结，并根据当前的研究进展，对未来
重症肾功能衰竭疾病的生存分析研究作进一步的展望。

%---------------------------------------
\section{总结}
%---------------------------------------


本文阐述了国内外关于生存分析的发展历程和研究成果，在生存分析应用中，通过分析和研究患者的随访数据，建立精
准的生存预后模型。对ICU中肾功能衰竭患者的死亡率预测是一项非常有意义的工作，它对医生评估疾病的严重程度、
确定适当的护理水平和提供关键的挽救生命的治疗都是至关重要的。本文针对ICU中患者死亡率预测的问题进行研究，
现在对该研究的工作总结如下：

对患者数据的缺失值问题综合考虑各种情况，不同类型和不同缺失率的变量均使用最合适的缺失值填充方法，以此来减
少数据质量对实验研究的影响。

由于目前对于神经网络生存分析的实证研究尚且较少，且对于目前生存分析的多变量真实数据验证较少，本文将最新提
出的6种生存分析模型应用到ICU肾功能衰竭患者临床资料上，对患者死亡率预测问题进行研究。

传统常见的生存评估指标为一致指数和BS指标，但其评估维度有限，本文采用了多种生存评估指标，以此来对不同模型
的全方面评估对比。对于比例风险模型本文采用一致性指数评估模型的区分度，对于非比例风险模型本文采
用$C^{td}$指数评估。采用ROC-Time来评价模型的预测精确度和稳定性。最后通过BS和IBS对模型的校准度进行评价。

对于本文研究的6个模型而言，在重症肾功能衰竭的死亡率预测问题上，预测的区分度最好的模型是Cox-CC模型，其次
为Cox-Time模型，在预测的精确度方面表现最好的是Cox-ElasticNet模型，在模型稳定性方面表现最好的是
Cox-CC模型，对于模型的校准度而言，表现最好的是RSF模型，最差的是Cox-ElasticNet模型。且对于
长期的预测精度和稳定性而言，Cox-CC表现最佳，对于中短期的而言，RSF表现最佳。

最后根据Cox-ElasticNet模型计算了重症肾功能衰竭患者的危险因素和保护因素，其中最重要的危险因素是：进入ICU后24小时内血尿素
氮值的最小值；最重要的保护因素是：进入ICU后24小时内氧合指数最小值。

%---------------------------------------
\section{展望}
%---------------------------------------

本文主要针生存分析的几种最新模型以及其在生存分析应用做了初步研究和大胆尝试，在生存分析中考虑了患者的大
量临床信息，通过对比评价各个模型的信息确定了对ICU中肾功能衰竭患者的一个最佳模型。在今后的研究工作中，
并着重对下列问题进行研究：

在患者数据提取上做进一步改善，本文中所提取的患者信息来自MIMIC-IV数据库，但目前可用的医学数据库还有很
多，例如eICU数据库，也包括了多中心的重症患者的信息；SEER数据库包含了人群的癌症诊断时的临床数据、治疗
信息和生存结局等。在后续的研究中可以从多个维度去提取患者的数据，使患者的信息更加丰富，从而有利于患者
死亡率预测的研究。

对于这6个生存分析模型对ICU中肾功能患者的死亡率预测模型的验证上，我们仅进行了内部数据的验证，缺乏在大样
本外部数据的基础上进行的模型评估，而且不同中心不同ICU单位的患者可能对重症肾功能疾病结果产生影响，由此可
能会对本研究结论基于其他数据库的数据来进行验证的结果有所影响。此外，对研究方法的验证进行适当的实地调查也是
不可或缺的，选取国内重症肾衰竭医院进行访谈、调研，对分析过程和结论的改进将有进一步的提升。

肾功能衰竭患者的影响除了临床信息和患者的环境因素外，受到的先天的基因影响也不可忽视，肾功能类疾病同样存
在许多的先天性疾病，这些疾病的发展发生，不止于环境相关，基因因素也有很大影响。本文虽然通过MIMIC-IV数据
库采集到了患者的众多临床特征，但是患者的基因序列相关信息无法采集得到。因此，此类结果还可以进一步采集到
患者的基因相关序列以此来进一步提升模型的预测效果。































